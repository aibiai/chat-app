<template>
  <div class="chat-page relative min-h-[75vh]">
    <!-- ËÉåÊôØÂ±ÇÔºöÂõ∫ÂÆöÂÖÖÊª°ËßÜÂè£ÔºåÁ°Æ‰øùÂú®‰ªª‰ΩïÂ±èÂπï‰∏äÈÉΩËÉΩÁúãÂà∞ËÉåÊôØÂõæ -->
    <div class="chat-bg fixed inset-0 z-0"></div>
    <div class="relative z-10 container mx-auto px-2 py-4">
      <div class="grid grid-cols-12 gap-3">
        <!-- Â∑¶ÂàóÔºöËÅäÂ§©Èù¢ÊùøÔºàÂÆ¢ÊúçÊ®°Âºè‰∏ãÊ∞¥Âπ≥Â±Ö‰∏≠Ôºâ -->
        <div :class="['col-span-12', isSupportSimple ? 'max-w-[696px] w-full mx-auto' : 'lg:col-span-9']">
          <div :class="['flex flex-col chat-card overflow-hidden rounded-2xl border bg-white/65 backdrop-blur-xl shadow-[0_10px_40px_rgba(0,0,0,.12)]', isSupportSimple ? 'h-[82vh]' : 'h-[80vh]']">
            <!-- È°∂ÈÉ®Êù°ÔºöÂ∑¶‰æß‰∏∫ÂèØÊêúÁ¥¢ËæìÂÖ•Ê°ÜÔºàÂç† 1/4 ÂÆΩÂ∫¶ÔºâÔºåÂè≥‰æß‰∏∫ÂΩìÂâç‰ºöËØùÊ†áÈ¢ò -->
            <div class="tab-bar" v-if="!isSupportSimple">
              <div class="tab tab--search">
                <div class="navlike-search">
                  <input v-model.trim="searchKey" @input="onSearchInput" type="search" :placeholder="t('chat.search.placeholder')" />
                  <button type="button" class="go" @click="doSearch" aria-label="search">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                  </button>
                </div>
              </div>
              <div class="tab active">{{ t('chat.withUser', { user: headerName }) }}</div>
            </div>
            <div v-else class="support-head flex items-center gap-3 px-4 py-3 border-b bg-white/70 backdrop-blur-md">
              <!-- ÂÆ¢ÊúçÂ§¥ÂÉèÔºö‰∏éÂè≥‰∏äËßí‚ÄúËÅîÁ≥ªÂÆ¢Êúç‚ÄùÂõæÊ†á‰∏ÄËá¥ÁöÑËÄ≥Êú∫ÂõæÊ†á -->
              <span class="cs-support-avatar cs-md" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <g fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 12a6 6 0 0 1 12 0" />
                    <path d="M6 12v2.1a1.9 1.9 0 0 0 1.9 1.9H9" />
                    <path d="M18 12v1.6" />
                    <path d="M18 16.3a2 2 0 0 1-2 2h-1.2" />
                  </g>
                  <circle cx="18.6" cy="16.3" r="1.2" fill="currentColor" />
                </svg>
              </span>
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <h3 class="font-bold text-gray-800 truncate">{{ t('nav.contactService') }}</h3>
                  <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-green-50 text-green-700 border border-green-200">{{ t('chat.support.online') }}</span>
                </div>
                <p class="text-xs text-gray-500 leading-snug">{{ t('chat.support.subtitle') }}</p>
              </div>
            </div>
            <div v-if="!isSupportSimple" class="flex-1 content-grid">
              <aside class="side-col">
                <!-- ÊêúÁ¥¢ÁªìÊûú‰ºòÂÖàÔºåÂê¶ÂàôÂ±ïÁ§∫ÁªèÂ∏∏ËÅäÂ§© -->
                <template v-if="searching">
                  <div class="muted text-sm">{{ t('chat.search.searching') }}</div>
                </template>
                <template v-else-if="searchKey">
                  <div v-if="searchResults.length" class="result-list">
                    <div v-for="u in searchResults" :key="u.id" class="result-item">
                      <AvatarImg :gender="(u.gender as any)" :size="36" />
                      <div class="ri-main">
                        <div class="ri-name" :title="u.nickname || u.id">{{ u.nickname || u.id }}</div>
                        <div class="ri-sub" :title="u.id">{{ t('chat.search.userId') }}{{ u.id }}</div>
                      </div>
                      <button type="button" class="ri-btn" @click="openChatWith(u.id)">{{ t('chat.actions.message') }}</button>
                    </div>
                  </div>
                  <div v-else class="muted text-sm">{{ t('chat.search.empty') }}</div>
                </template>
                <template v-else>
                  <div class="recent-head">{{ t('chat.recent.title') }}</div>
                  <div v-if="recentList.length" class="recent-list">
                    <div v-for="c in recentList" :key="c.peerId" class="recent-item" @click="openChatWith(c.peerId)">
                      <AvatarImg :gender="(c.peer.gender as any)" :size="34" />
                      <div class="rc-main">
                        <div class="rc-top">
                          <span class="rc-name" :title="c.peer.nickname">{{ c.peer.nickname }}</span>
                          <span class="rc-time">{{ formatRelative(c.lastAt) }}</span>
                        </div>
                        <div class="rc-msg" :title="c.lastContent">{{ c.lastContent }}</div>
                      </div>
                      <span v-if="c.unread>0" class="rc-unread">{{ c.unread>99 ? '99+' : c.unread }}</span>
                    </div>
                  </div>
                  <div v-else class="muted text-sm">{{ t('chat.recent.empty') }}</div>
                </template>
              </aside>
              <div class="chat-col flex flex-col">
                <div ref="chatBody" class="flex-1 min-h-0 overflow-auto px-0 py-3 space-y-2 chat-body">
                  <!-- Á©∫ÊÄÅÊèêÁ§∫Ôºà‰ªÖÂÆ¢Êúç‰ºöËØùÂ±ïÁ§∫ÔºõÊôÆÈÄöÁî®Êà∑‰ºöËØù‰∏çÂ±ïÁ§∫Ôºâ -->
                  <div v-if="messages.length === 0 && peerId==='support'" class="flex flex-col items-center justify-center h-[40vh] text-gray-500">
                    <div class="text-4xl mb-2">üòä</div>
                    <p class="font-semibold">{{ t('chat.support.hello') }}</p>
                    <p class="text-sm">{{ t('chat.support.subtitle') }}</p>
                  </div>
                  <div v-else v-for="m in messages" :key="m.id" class="flex items-end" :class="m.fromUserId===me ? 'justify-end' : 'justify-start'">
                    <!-- Â∑¶‰æßÔºöÂØπÊñπÊ∂àÊÅØÂ§¥ÂÉè -->
                    <div v-if="m.fromUserId!==me" class="mr-2">
                      <template v-if="isSupportSimple">
                        <span class="cs-support-avatar cs-sm" aria-hidden="true">
                          <svg viewBox="0 0 24 24">
                            <g fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 12a6 6 0 0 1 12 0" />
                              <path d="M6 12v2.1a1.9 1.9 0 0 0 1.9 1.9H9" />
                              <path d="M18 12v1.6" />
                              <path d="M18 16.3a2 2 0 0 1-2 2h-1.2" />
                            </g>
                            <circle cx="18.6" cy="16.3" r="1.2" fill="currentColor" />
                          </svg>
                        </span>
                      </template>
                      <template v-else>
                        <AvatarImg :gender="peerGender" :size="28" :alt="'peer avatar'" />
                      </template>
                    </div>
                    <!-- Ê∂àÊÅØÊ∞îÊ≥° -->
                    <span class="inline-block max-w-[75%] rounded-xl px-3 py-2 break-words shadow-sm"
                      :class="m.fromUserId===me ? 'bg-main text-white' : 'bg-white/90 border border-gray-200'">
                      <div @click.stop="openMsgTrMenu($event, m)">
                        <template v-if="!shouldShowDual(m)">
                          {{ loadingAnyTranslation(m) ? translatingLabel : (isAnyTranslationFailed(m) ? failedLabel : (getAnyTranslation(m) || displayContent(m))) }}
                        </template>
                        <template v-else>
                          <div class="line-1">{{ getAnyTranslation(m) || displayContent(m) }}</div>
                          <div class="line-2" :class="{muted: !hasAnyTranslation(m)}">{{ hasAnyTranslation(m) ? m.content : (loadingAnyTranslation(m) ? translatingLabel : (isAnyTranslationFailed(m) ? failedLabel : m.content)) }}</div>
                        </template>
                      </div>
                    </span>
                    <!-- Âè≥‰æßÔºöÊàëÁöÑÊ∂àÊÅØÂ§¥ÂÉè -->
                    <div v-if="m.fromUserId===me" class="ml-2">
                      <AvatarImg :gender="myGender" :size="28" :alt="'my avatar'" />
                    </div>
                  </div>
                </div>
                <!-- Â∫ïÈÉ®ËæìÂÖ•Âå∫Ôºö‰ªÖÂç†Âè≥‰æßÂàóÂÆΩÂ∫¶ -->
                <form class="px-3 md:px-4 py-3 md:py-4 border-t chat-input bg-white/70 backdrop-blur-lg" @submit.prevent="send">
                  <div class="composer">
          <textarea ref="msgInput" v-model="content" :placeholder="t('chat.placeholder')" rows="1"
          @input="autoResize" @keydown.enter.exact.prevent="onEnterSend($event)" @keydown.enter.shift.stop
          class="flex-1 px-3 py-2 text-[15px] outline-none bg-transparent resize-none overflow-hidden leading-[1.35] max-h-[140px]" />
                    <div class="tools relative flex items-center gap-2">
                      <button type="button" class="circle-icon" aria-label="emoji" ref="emojiBtn" @click.stop="toggleEmoji($event)" @mousedown.stop>üòä</button>
                      <button type="button" class="circle-icon" aria-label="image" @click="onImageClick">üñºÔ∏è</button>
                      <button type="button" class="circle-icon" aria-label="gift" ref="giftBtn" @click.stop="toggleGift($event)">üéÅ</button>
                      <button type="button" class="circle-icon" aria-label="more" ref="moreBtn" @click="toggleLangMenu($event)">‚ãØ</button>
                      <!-- ËØ≠Ë®ÄÈÄâÊã©ËèúÂçïÔºàÁõ∏ÂØπ tools ÂÆπÂô®ÂÆö‰ΩçÔºâ -->
                      <div v-if="langMenuOpen" ref="langMenuRef" class="lang-menu absolute bottom-full right-0 mb-2">
                        <div class="tip" aria-hidden="true"></div>
                        <div class="group-title">{{ t('chat.menu.translateTo') }}</div>
                        <button type="button" class="menu-item" :class="{ active: !langTarget }" @click="chooseLang(null)">{{ t('chat.menu.showOriginal') }}</button>
                        <button v-for="opt in LANG_OPTIONS" :key="opt.code" type="button" class="menu-item" :class="{ active: langTarget===opt.code }" @click="chooseLang(opt.code)">
                          <span>{{ opt.label }}</span>
                          <svg v-if="langTarget===opt.code" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"/></svg>
                        </button>
                        <div class="divider" role="separator" aria-hidden="true"></div>
                        <label class="menu-item toggle">
                          <span>{{ t('chat.menu.dualMode') }}</span>
                          <input type="checkbox" v-model="dualMode" />
                        </label>
                      </div>
                    </div>
                    <button class="send-btn rounded-full px-5 py-2 disabled:opacity-60 disabled:cursor-not-allowed" :disabled="!content.trim()">{{ t('chat.send') }}</button>
                  </div>
                </form>
              </div>
            </div>
            <div v-else ref="chatBody" class="flex-1 overflow-auto px-4 py-3 space-y-2 chat-body">
              <!-- Á©∫ÊÄÅÊèêÁ§∫ÔºàÊó†ÂéÜÂè≤Ê∂àÊÅØÊó∂Ôºâ -->
              <div v-if="messages.length === 0" class="flex flex-col items-center justify-center h-[40vh] text-gray-500">
                <div class="text-4xl mb-2">üòä</div>
                <p class="font-semibold">{{ t('chat.support.hello') }}</p>
                <p class="text-sm">{{ t('chat.support.subtitle') }}</p>
              </div>
              <div v-else v-for="m in messages" :key="m.id" class="flex items-end" :class="m.fromUserId===me ? 'justify-end' : 'justify-start'">
                <!-- Â∑¶‰æßÔºöÂØπÊñπÊ∂àÊÅØÂ§¥ÂÉè -->
                <div v-if="m.fromUserId!==me" class="mr-2">
                  <template v-if="isSupportSimple">
                    <span class="cs-support-avatar cs-sm" aria-hidden="true">
                      <svg viewBox="0 0 24 24">
                        <g fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M6 12a6 6 0 0 1 12 0" />
                          <path d="M6 12v2.1a1.9 1.9 0 0 0 1.9 1.9H9" />
                          <path d="M18 12v1.6" />
                          <path d="M18 16.3a2 2 0 0 1-2 2h-1.2" />
                        </g>
                        <circle cx="18.6" cy="16.3" r="1.2" fill="currentColor" />
                      </svg>
                    </span>
                  </template>
                  <template v-else>
                    <AvatarImg :gender="peerGender" :size="28" :alt="'peer avatar'" />
                  </template>
                </div>
                <!-- Ê∂àÊÅØÊ∞îÊ≥° -->
                <span class="inline-block max-w-[75%] rounded-xl px-3 py-2 break-words shadow-sm"
                  :class="m.fromUserId===me ? 'bg-main text-white' : 'bg-white/90 border border-gray-200'">
                  <div @click.stop="openMsgTrMenu($event, m)">
                    <template v-if="!shouldShowDual(m)">
                      {{ loadingAnyTranslation(m) ? translatingLabel : (isAnyTranslationFailed(m) ? failedLabel : (getAnyTranslation(m) || displayContent(m))) }}
                    </template>
                    <template v-else>
                      <div class="line-1">{{ getAnyTranslation(m) || displayContent(m) }}</div>
                      <div class="line-2" :class="{muted: !hasAnyTranslation(m)}">{{ hasAnyTranslation(m) ? m.content : (loadingAnyTranslation(m) ? translatingLabel : (isAnyTranslationFailed(m) ? failedLabel : m.content)) }}</div>
                    </template>
                  </div>
                </span>
                <!-- Âè≥‰æßÔºöÊàëÁöÑÊ∂àÊÅØÂ§¥ÂÉè -->
                <div v-if="m.fromUserId===me" class="ml-2">
                  <AvatarImg :gender="myGender" :size="28" :alt="'my avatar'" />
                </div>
              </div>
            </div>
            <!-- Â∫ïÈÉ®ËæìÂÖ•Âå∫Ôºà‰ªÖÊñáÂ≠óËæìÂÖ•ÔºõÂÆ¢ÊúçÁÆÄÂåñÊ®°ÂºèÊòæÁ§∫Âú®Êï¥ÂÆΩ‰∏ãÊñπÔºâ -->
            <form v-if="isSupportSimple" class="p-3 md:p-4 border-t chat-input bg-white/70 backdrop-blur-lg" @submit.prevent="send">
              <div class="composer">
                <textarea ref="msgInput" v-model="content" :placeholder="t('chat.placeholder')" rows="1"
                          @input="autoResize" @keydown.enter.exact.prevent="onEnterSend($event)" @keydown.enter.shift.stop
                          class="flex-1 px-3 py-2 text-[15px] outline-none bg-transparent resize-none overflow-hidden leading-[1.35] max-h-[140px]" />
                <button class="send-btn rounded-full px-5 py-2 disabled:opacity-60 disabled:cursor-not-allowed" :disabled="!content.trim()">{{ t('chat.send') }}</button>
              </div>
            </form>
          </div>
        </div>

  <!-- Âè≥ÂàóÔºöÁ§ºÁâ©‰∏é‰ºöÂëò‰∫§ÂèãÁâπÊùÉÔºàÂÆ¢ÊúçÊ®°ÂºèÈöêËóèÔºâ -->
        <div class="col-span-12 lg:col-span-3" v-if="!isSupportSimple">
          <div class="bg-white rounded border p-3">
            <h3 class="font-semibold mb-2">{{ t('chat.side.gift.title') }}</h3>
            <div class="flex items-start gap-2">
              <div class="text-2xl">üéÅ</div>
              <p class="text-gray-600 leading-snug text-sm">{{ t('chat.side.gift.desc') }}</p>
            </div>
            <button class="mt-2 w-full rounded bg-main text-white py-2 hover:brightness-105" type="button" @click="openGiftModal">{{ t('chat.side.gift.cta') }}</button>
          </div>

          <div class="bg-white rounded border p-3 mt-4">
            <h3 class="font-semibold mb-2">{{ t('chat.side.vip.title') }}</h3>
            <ul class="space-y-2 text-gray-700 text-sm leading-snug">
              <li class="flex gap-2"><span class="text-xl">üëë</span><div>{{ t('chat.side.vip.benefit1') }}</div></li>
              <li class="flex gap-2"><span class="text-xl">üëÄ</span><div>{{ t('chat.side.vip.benefit2') }}</div></li>
              <li class="flex gap-2"><span class="text-xl">‚úâÔ∏è</span><div>{{ t('chat.side.vip.benefit3') }}</div></li>
              <li class="flex gap-2"><span class="text-xl">üíó</span><div>{{ t('chat.side.vip.benefit4') }}</div></li>
            </ul>
            <button class="mt-3 w-full rounded bg-amber-400 text-white py-2 hover:brightness-105" type="button" @click="openVipNow">{{ t('chat.side.vip.cta') }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Á§ºÁâ©ÂïÜÂüéÊ®°ÊÄÅÊ°ÜÔºàteleport Âà∞ bodyÔºåË¶ÜÁõñÂÖ®Â±ÄÔºâ -->
  <teleport to="body">
    <div v-if="giftModalOpen" class="gift-modal fixed inset-0 z-[120]">
      <div class="gm-mask absolute inset-0 bg-black/40" @click="closeGiftModal"></div>
      <div class="gm-wrap absolute inset-0 p-4 md:p-6 grid place-items-center">
        <div class="gm-panel w-full max-w-3xl bg-white/95 backdrop-blur rounded-2xl border shadow-2xl overflow-hidden">
          <div class="gm-head flex items-center justify-between px-4 py-3 border-b">
            <div class="flex items-center gap-2">
              <span class="text-2xl">üéÅ</span>
              <h3 class="font-bold text-lg">{{ t('chat.gift.modal.title') }}</h3>
            </div>
            <button type="button" class="circle-icon" aria-label="close" @click="closeGiftModal">‚úï</button>
          </div>
          <div class="gm-body p-4">
            <div v-if="giftLoading" class="text-center py-10 text-gray-500">{{ t('common.loading') }}</div>
            <div v-else-if="giftError" class="text-center py-10 text-red-500">{{ giftError }}</div>
            <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <div v-for="g in giftCatalog" :key="g.id" class="g-card">
                <div class="g-thumb"><img :src="g.img" :alt="g.name" /></div>
                <div class="g-meta">
                  <div class="g-name">{{ g.name }}</div>
                  <div class="g-price">¬• {{ g.price }}</div>
                </div>
                <button class="g-send" type="button" @click="sendGift(g)">{{ t('chat.gift.send') }}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </teleport>

  <!-- Á§ºÁâ©Ê∞îÊ≥°Èù¢ÊùøÔºàÈîöÂÆöÂà∞Á§ºÁâ©ÊåâÈíÆÔºåÁ±ª‰ººË°®ÊÉÖÈù¢ÊùøÔºâ -->
  <teleport to="body">
    <div v-if="giftOpen" class="gift-popover" ref="giftPanelRef">
      <div class="gp-head">
  <div class="gp-title"><span class="emoji">üéÅ</span> {{ t('chat.side.gift.title') }}</div>
        <button type="button" class="gp-close" @click="closeGiftPanel">‚úï</button>
      </div>
      <div class="gp-body">
        <div v-if="giftLoading" class="gp-loading">{{ t('common.loading') }}</div>
        <div v-else-if="giftError" class="gp-error">{{ giftError }}</div>
        <div v-else class="gp-grid">
          <button v-for="g in giftCatalog" :key="g.id" class="gp-item" type="button" @click="sendGiftAndClose(g)">
            <div class="thumb"><img :src="g.img" :alt="g.name" /></div>
            <div class="name" :title="g.name">{{ g.name }}</div>
            <div class="price">¬• {{ g.price }}</div>
          </button>
        </div>
      </div>
      <div class="gp-foot">
        <button type="button" class="gp-more" @click="openGiftModalFromPanel">{{ t('chat.gift.openMall') }}</button>
      </div>
    </div>
  </teleport>

  <!-- ÊñáÊú¨ÈÄâÊã©ÔºöÁøªËØëÊÇ¨ÊµÆËèúÂçï‰∏éÁªìÊûú -->
  <teleport to="body" v-if="ENABLE_SELECTION_TRANSLATE">
    <div v-if="selOpen" class="seltr-wrap fixed z-[125]" :style="{ left: selPos.left+'px', top: selPos.top+'px' }">
      <div class="seltr-box">
        <button type="button" class="seltr-btn" @click="toggleSelLangMenu">
          {{ translateLabel }}
        </button>
        <div v-if="selLangOpen" class="seltr-lang">
          <button v-for="opt in LANG_AUTONYMS" :key="opt.code" type="button" class="lang-item" @click="translateSelection(opt.code)">{{ opt.label }}</button>
        </div>
      </div>
      <div v-if="selResultOpen" class="seltr-result">
        <div class="content">{{ selLoading ? translatingLabel : selResult }}</div>
        <div class="actions">
          <button type="button" @click="copySelResult">{{ copyLabel }}</button>
          <button type="button" @click="closeSelPanel">{{ closeLabel }}</button>
        </div>
      </div>
    </div>
  </teleport>

  <!-- ÂçïÊù°Ê∂àÊÅØÔºöÁøªËØëËèúÂçïÔºàÁÇπÂáªÊ∞îÊ≥°ÂºπÂá∫Ôºâ -->
  <teleport to="body">
    <div v-if="msgTrOpen" class="msgtr-menu fixed z-[126]" :style="{ left: msgTrPos.left+'px', top: msgTrPos.top+'px' }">
      <div class="msgtr-head">{{ t('chat.menu.translateTo') }}</div>
      <div class="msgtr-list">
        <button v-for="opt in LANG_OPTIONS" :key="opt.code" type="button" class="msgtr-item" @click="translateMsgTo(opt.code)">{{ opt.label }}</button>
      </div>
    </div>
  </teleport>
</template>

<script setup lang="ts">
import { onMounted, onUnmounted, ref, computed, watch, nextTick } from 'vue';
// emoji ÈÄâÊã©Âô®Ê†∑ÂºèÔºàÁ°Æ‰øùÂºπÂ±ÇÂèØËßÅ‰∏éÂ∏ÉÂ±ÄÊ≠£Â∏∏Ôºâ
// Ê≥®ÔºöÊóßÁâà emoji-button ÁöÑ CSS Ë∑ØÂæÑÂú®‰∏çÂêåÁâàÊú¨Â∑ÆÂºÇËæÉÂ§ßÔºåÁõ¥Êé•ÂºïÂÖ•‰ºöÂØºËá¥ÊûÑÂª∫Â§±Ë¥•
// ËøôÈáåÁßªÈô§Áõ¥Êé• CSS ÂØºÂÖ•ÔºåËΩ¨ËÄå‰ΩøÁî®Êú¨Êñá‰ª∂‰∏≠ÁöÑËΩªÈáèÂÖ®Â±ÄÊ†∑Âºè‰ª•‰øùËØÅÂèØËßÅÊÄß
// ÂºÄÊ∫êË°®ÊÉÖÈÄâÊã©Âô®Ôºàemoji-buttonÔºâ
// ‰ºòÂÖà‰ΩøÁî®Áª¥Êä§‰∏≠ÁöÑ @joeattardi/emoji-buttonÔºåÂÖºÂÆπÊóßÂåÖÂêç emoji-button
let EmojiButton: any | null = null
// Áî±‰∫éÈÉ®ÂàÜÊµèËßàÂô®/ÁéØÂ¢É‰∏ãÁ¨¨‰∏âÊñπ emoji-button Âú®ÂÆö‰Ωç‰∏éÂÖ≥Èó≠‰∏äÂ≠òÂú®ÂÖºÂÆπÊÄßÈóÆÈ¢òÔºå
// ËøôÈáåÈªòËÆ§ÂÖ≥Èó≠ÂÖ∂‰ΩøÁî®ÔºåÊîπ‰∏∫Á®≥ÂÆöÁöÑÂÜÖÁΩÆÈù¢ÊùøÔºõÂ¶ÇÈúÄÂêØÁî®ÂèØÊîπ‰∏∫ true„ÄÇ
const USE_EMOJI_BUTTON = false
import { useI18n } from 'vue-i18n';
import { useRoute } from 'vue-router';
import { useRouter } from 'vue-router';
import { Socket } from 'socket.io-client';
import api from '../api';
import { getSocket } from '../socket';
import { useAuth } from '../stores';
import AvatarImg from '../components/AvatarImg.vue'

interface Message { id: string; fromUserId: string; toUserId: string; content: string; createdAt: number }
type Gender = 'male'|'female'|'other'

const route = useRoute();
const router = useRouter();
const peerId = computed(() => route.params.id as string);
const peerNickname = ref<string>('')
const headerName = computed(() => {
  if (peerId.value === 'support') return t('nav.contactService')
  return peerNickname.value || String(peerId.value)
})
const messages = ref<Message[]>([]);
const seen = new Set<string>();
const content = ref('');
const auth = useAuth();
const me = ref<string>(auth.uid || localStorage.getItem('uid') || '');
let socket: Socket | null = null;
const { t, locale } = useI18n();
const myGender = ref<Gender>('other')
const peerGender = ref<Gender>('other')
const isSupportSimple = computed(() => peerId.value === 'support')
const isGuestSupport = computed(() => !localStorage.getItem('token') && peerId.value === 'support')
const guestId = computed(() => {
  const key = 'guestId';
  let id = localStorage.getItem(key);
  if (!id) { id = Math.random().toString(36).slice(2); localStorage.setItem(key, id); }
  return id;
})

// ======== ËÅäÂ§©ÁøªËØëÔºàËØ≠Ë®ÄËèúÂçï + ÁºìÂ≠òÔºâ ========
type TargetLang = 'zh-CN'|'zh-TW'|'en'|'ko'|'ja'
const LANG_OPTIONS: Array<{ code: TargetLang; label: string }> = [
  { code: 'zh-CN', label: 'ÁÆÄ‰Ωì‰∏≠Êñá' },
  { code: 'zh-TW', label: 'ÁπÅÈ´î‰∏≠Êñá' },
  { code: 'en', label: 'English' },
  { code: 'ko', label: 'ÌïúÍµ≠Ïñ¥' },
  { code: 'ja', label: 'Êó•Êú¨Ë™û' }
]
const moreBtn = ref<HTMLElement | null>(null)
const langMenuRef = ref<HTMLElement | null>(null)
const langMenuOpen = ref(false)
const langTarget = ref<TargetLang | null>(null)
const dualMode = ref(false)
// ÁÆÄÂçïÁºìÂ≠òÔºökey = messageId + '|' + target
const translateCache = new Map<string, string>()
// ÁâàÊú¨Âè∑ÔºöÊØèÂΩìÂÜôÂÖ•ÁºìÂ≠òÂêéËá™Â¢û‰ª•Ëß¶ÂèëÊ∏≤Êüì
const translateVersion = ref(0)
// ÁÆÄÊòìÂπ∂ÂèëÊ±†ÔºöÈôêÂà∂Âπ∂ÂèëÔºåÊèêÈ´òÊï¥‰ΩìÈÄüÂ∫¶‰∏îÈÅøÂÖçÁ™ÅÂèëËøáÂ§öËØ∑Ê±Ç
async function runPool<T, R>(list: T[], limit: number, worker: (item: T, index: number) => Promise<R>): Promise<R[]> {
  const ret: R[] = []
  let i = 0
  const exec = async () => {
    for (;;) {
      const idx = i++
      if (idx >= list.length) return
      const r = await worker(list[idx], idx)
      ret[idx] = r
    }
  }
  const tasks = Array.from({ length: Math.min(limit, Math.max(1, list.length)) }, exec)
  await Promise.allSettled(tasks)
  return ret
}
// ÂçïÊù°Ê∂àÊÅØÁøªËØëËèúÂçï
const msgTrOpen = ref(false)
const msgTrPos = ref({ left: 0, top: 0 })
const msgTrTarget = ref<Message | null>(null)
// Áî®Êà∑ÈíàÂØπÂçïÊù°Ê∂àÊÅØÈÄâÊã©ÁöÑÁõÆÊ†áËØ≠Ë®Ä
const msgTargetLang = new Map<string, TargetLang>()
// ËÆ∞ÂΩïÂ§±Ë¥• keyÔºö`messageId|target`
const translateFailed = new Set<string>()

function displayContent(m: Message){
  // ËØªÂèñÁâàÊú¨Âè∑‰Ωú‰∏∫‰æùËµñÔºåÁ°Æ‰øùÁºìÂ≠òÊõ¥Êñ∞ÂêéËß¶ÂèëÈáçÊ∏≤Êüì
  void translateVersion.value
  if (!langTarget.value) return m.content
  const key = `${m.id}|${langTarget.value}`
  const t = translateCache.get(key)
  if (!dualMode.value) return t || m.content
  // ÂèåËØ≠Ê®°ÂºèÔºöËØëÊñá‰ºòÂÖàÊòæÁ§∫Ôºå‰∏ã‰∏ÄË°åÊòæÁ§∫ÂéüÊñáÔºõËã•ËØëÊñáÂ∞öÊú™Âà∞ËææÔºåÂ±ïÁ§∫Âç†‰Ωç
  if (t) return `${t}`
  return m.content
}

function getTranslation(m: Message): string | null {
  if (!langTarget.value) return null
  const key = `${m.id}|${langTarget.value}`
  return translateCache.get(key) || null
}
function hasTranslation(m: Message): boolean { return !!getTranslation(m) }
function loadingTranslation(m: Message): boolean { return !!langTarget.value && !hasTranslation(m) }

// ===== ÂçïÊù°Ê∂àÊÅØÂºπÂá∫ÁøªËØëËèúÂçïÔºà‰∫îÁßçËØ≠Ë®ÄÔºâ =====
function openMsgTrMenu(e: MouseEvent, m: Message){
  // ÂÆö‰ΩçÂà∞Ê∞îÊ≥°‰∏äÊñπ
  const t = e.currentTarget as HTMLElement
  const r = t.getBoundingClientRect()
  const pad = 8
  const top = Math.max(pad, r.top + window.scrollY - 44)
  const left = Math.min(window.innerWidth - 200, Math.max(pad, r.left + r.width/2 - 80))
  msgTrPos.value = { left, top }
  msgTrTarget.value = m
  msgTrOpen.value = true
  // Â§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠
  window.addEventListener('pointerdown', onCloseMsgTr, { once: true, capture: true })
}
function onCloseMsgTr(ev: PointerEvent){
  const panel = document.querySelector('.msgtr-menu') as HTMLElement | null
  if (!panel){ msgTrOpen.value = false; return }
  const t = ev.target as Node
  if (panel.contains(t)) return
  msgTrOpen.value = false
}
async function translateMsgTo(code: TargetLang){
  const m = msgTrTarget.value
  if (!m) return
  const key = `${m.id}|${code}`
  // 1) ÂÖàËÆ∞ÂΩïÁõÆÊ†áËØ≠Ë®ÄÂπ∂ÂÖ≥Èó≠ËèúÂçï -> Á´ãÂç≥ËøõÂÖ•‚ÄúÁøªËØë‰∏≠‚ÄùÁä∂ÊÄÅ
  msgTargetLang.set(m.id, code)
  msgTrOpen.value = false
  translateVersion.value++
  if (typeof translateFailed !== 'undefined') translateFailed.delete(key)
  // 2) Ëã•Êó†ÁºìÂ≠òÔºåÂºÇÊ≠•ÊãâÂèñÁøªËØë
  if (!translateCache.has(key)){
    const srcGuess = detectLangForText(m.content)
    const sNorm = normLang(srcGuess)
    const tNorm = normLang(code)
    const t = (sNorm === tNorm) ? m.content : await translateTextSafe(m.content, srcGuess, code)
    if (t){ translateCache.set(key, t); translateVersion.value++ }
    else { if (typeof translateFailed !== 'undefined') translateFailed.add(key); translateVersion.value++ }
  }
}

// Áî®‰∫éÊú¨Êù°ÂèåËØ≠Â±ïÁ§∫ÁöÑ‰æøÊç∑ÊñπÊ≥ïÔºà‰ºòÂÖàÂΩìÂâçËèúÂçïÁõÆÊ†áËØ≠Ë®ÄÔºåÂÖ∂Ê¨°ÂÖ®Â±ÄËØ≠Ë®ÄÔºâ
function resolveTargetForMsg(m?: Message): TargetLang | null{
  if (m && msgTargetLang.has(m.id)) return msgTargetLang.get(m.id) as TargetLang
  return (langTarget.value as TargetLang | null) || null
}
function getAnyTranslation(m: Message): string | null{
  void translateVersion.value
  const tgt = resolveTargetForMsg(m)
  if (!tgt) return null
  const key = `${m.id}|${tgt}`
  return translateCache.get(key) || null
}
function hasAnyTranslation(m: Message){ return !!getAnyTranslation(m) }
function loadingAnyTranslation(m: Message){
  void translateVersion.value
  const tgt = resolveTargetForMsg(m); if (!tgt) return false
  const key = `${m.id}|${tgt}`
  return !translateCache.has(key) && !(typeof translateFailed !== 'undefined' && translateFailed.has(key))
}
function isAnyTranslationFailed(m: Message){
  void translateVersion.value
  const tgt = resolveTargetForMsg(m); if (!tgt) return false
  const key = `${m.id}|${tgt}`
  return (typeof translateFailed !== 'undefined') && translateFailed.has(key)
}
function shouldShowDual(m: Message){
  // ‰ªÖÂΩìÁî®Êà∑ÂºÄÂêØ‚ÄúÂèåËØ≠‚Äù‰∏îÂ≠òÂú®ÁõÆÊ†áËØ≠Ë®ÄÊó∂Ôºå‰ª•ÂèåË°åÊòæÁ§∫
  return !!dualMode.value && !!resolveTargetForMsg(m)
}

function toggleLangMenu(e?: MouseEvent){
  e?.stopPropagation()
  langMenuOpen.value = !langMenuOpen.value
  if (langMenuOpen.value){
    // ÂÆö‰ΩçÂà∞Â∑•ÂÖ∑Êù°‰∏äÊñπ
    nextTick(() => positionLangMenu())
    window.addEventListener('click', onDocClickCloseLang, { once: true })
  }
}
function onDocClickCloseLang(ev: MouseEvent){
  const menu = langMenuRef.value
  const btn = moreBtn.value
  if (!menu) { langMenuOpen.value = false; return }
  const t = ev.target as Node
  if (menu.contains(t) || (btn && btn.contains(t))) {
    // ÁÇπÂáª‰∫ÜËèúÂçïÂÜÖÈÉ®ÊàñÊåâÈíÆÔºå‰∏çÂÖ≥Èó≠„ÄÇÈáçÊñ∞ÁõëÂê¨‰∏ã‰∏ÄÊ¨°ÊñáÊ°£ÁÇπÂáª„ÄÇ
    window.addEventListener('click', onDocClickCloseLang, { once: true })
    return
  }
  langMenuOpen.value = false
}
function positionLangMenu(){
  const menu = langMenuRef.value
  if (!menu) return
  // Â∑≤‰ΩøÁî® absolute bottom-full right-0 + mb-2 Áõ∏ÂØπ tools ÂÆπÂô®ÂÆö‰ΩçÔºåËøôÈáåÂè™ÂÅöËßÜÂè£ÂæÆË∞É
  const rect = menu.getBoundingClientRect()
  if (rect.left < 8) menu.style.left = `${8 - rect.left}px`
}

async function chooseLang(code: TargetLang | null){
  langTarget.value = code
  langMenuOpen.value = false
  // ÂÖ®Â±ÄÈÄâÊã©ËØ≠Ë®ÄÂêéÔºåÊ∏ÖÈô§ÂçïÊù°Ê∂àÊÅØÁöÑÁõÆÊ†áËØ≠Ë®ÄË¶ÜÁõñÔºåÈÅøÂÖç‚ÄúÊó†ÂèçÂ∫î‚ÄùÔºà‰ªç‰øùÁïôÁºìÂ≠ò‰ª•Â§çÁî®Ôºâ
  msgTargetLang.clear()
  // ‰∏çÂêå‰∫éÊôÆÈÄöÂìçÂ∫îÂºèÂØπË±°ÔºåMap ÁöÑÂèòÊõ¥‰∏ç‰ºöËß¶ÂèëÊ∏≤ÊüìÔºåËøôÈáåÁî®ÁâàÊú¨Âè∑ÊâãÂä®Ëß¶Âèë
  translateVersion.value++
  if (!code) {
    // ÂàáÂõûÊòæÁ§∫ÂéüÊñáÊó∂Áõ¥Êé•ËøîÂõûÔºà‰∏çËß¶ÂèëÊâπÈáèÁøªËØëÔºâ
    return
  }
  // ÁªßÁª≠ÔºöÈÄâÊã©‰∫ÜÂÖ∑‰ΩìÁõÆÊ†áËØ≠Ë®ÄÔºåÂºÄÂßãÊâπÈáèÁøªËØëÔºõÂú®Âä†ËΩΩÈò∂ÊÆµÊòæÁ§∫‚ÄúÁøªËØë‰∏≠‚Ä¶‚Äù
  // ÊâπÈáèÁøªËØëÂΩìÂâçÂ∑≤Âä†ËΩΩÁöÑÊ∂àÊÅØ‰∏≠Â∞öÊú™ÁºìÂ≠òÁöÑÈÉ®ÂàÜ
  const source = guessSourceLang()
  const batch: Array<{ m: Message; key: string }> = []
  for (const m of messages.value){
    const key = `${m.id}|${code}`
    if (!translateCache.has(key)) {
      // Ëã•Ê≠§ÂâçËØ•Êù°ÁõÆÊ†áËØ≠Ë®ÄÁøªËØëÂ§±Ë¥•ÔºåÂÖàÁßªÈô§Â§±Ë¥•Ê†áËÆ∞‰ª•Â±ïÁ§∫‚ÄúÁøªËØë‰∏≠‚Ä¶‚ÄùÔºåÂπ∂ÂÖÅËÆ∏ÈáçËØï
      if (typeof translateFailed !== 'undefined') translateFailed.delete(key)
      batch.push({ m, key })
    }
  }
  if (!batch.length) return
  // Âπ∂ÂèëÁøªËØëÔºåÈôêÂà∂Âπ∂ÂèëÊï∞
  await runPool(batch, 6, async (item) => {
    const sNorm = normLang(source as string)
    const tNorm = normLang(code)
    const translated = (sNorm === tNorm) ? item.m.content : await translateTextSafe(item.m.content, source as string, code)
    if (translated) { translateCache.set(item.key, translated); translateVersion.value++ }
    else { if (typeof translateFailed !== 'undefined') translateFailed.add(item.key); translateVersion.value++ }
    return null as any
  })
}

function guessSourceLang(): TargetLang | 'auto' {
  // ÁÆÄÂåñÔºöËã•ÂåÖÂê´Â§ßÈáè‰∏≠ÊñáÂ≠óÁ¨¶ÂàôËÆ§‰∏∫ÊòØ zh-CNÔºåÂê¶Âàô auto ‰∫§ÁªôÊúçÂä°Á´Ø
  const text = messages.value.slice(-10).map(m=>m.content).join('\n')
  const zhRatio = (text.match(/[\u4e00-\u9fa5]/g) || []).length / Math.max(1, text.length)
  if (zhRatio > 0.2) return 'zh-CN'
  return 'auto' as any
}

async function translateTextSafe(q: string, source: string, target: string){
  try{
    // ‰øùÁïôÁπÅ‰ΩìÁõÆÊ†áÔºåÈÅøÂÖçË¢´ÂΩìÊàêÁÆÄ‰ΩìÂØºËá¥ÁªìÊûú‰∏çÂØπÔºõÂêéÁ´Ø‰ºöËá™Ë°åÂÅöÂÖºÂÆπ/ÂõûÈÄÄ
    const norm = (c: string) => ({ 'zh': 'zh', 'en': 'en', 'ja': 'ja', 'ko': 'ko', 'auto': 'auto' } as Record<string,string>)[c] || c
    const { data } = await api.post('/api/content/translate', { q, source: norm(source), target: norm(target), format: 'text' })
    const t = data?.data?.translatedText || data?.data?.translation || null
    // ËøáÊª§Â∏∏ËßÅÈîôËØØÊèêÁ§∫ÔºàÂ¶Ç Lingva Ë¶ÅÊ±Ç‰∏çÂêåËØ≠Ë®ÄÔºâ
    const s = typeof t === 'string' ? String(t).trim() : ''
    const lower = s.toLowerCase()
    const isError = lower.includes('please select two distinct languages') || lower.includes('select two different languages')
    if (isError) return null
    return typeof t === 'string' ? t : null
  }catch{
    return null
  }
}

// ËØ≠Ë®ÄËßÑËåÉÂåñ‰∏éËΩªÈáèÊú¨Âú∞Ê£ÄÊµã
// Ê≥®ÊÑèÔºö‰∏çË¶ÅÂ∞Ü zh-CN ‰∏é zh-TW ÂΩí‰∏Ä‰∏∫Âêå‰∏ÄÂÄºÔºåÂê¶Âàô‰ºöÊää‚ÄúÁÆÄ‰Ωì‚ÜíÁπÅ‰Ωì‚ÄùÁöÑÁøªËØëËØØÂà§‰∏∫‚ÄúÂêåËØ≠Áßç‚ÄùËÄåË∑≥Ëøá
function normLang(c: string){ return ({ 'zh': 'zh', 'zh-CN': 'zh-CN', 'zh-TW': 'zh-TW', 'en': 'en', 'ja': 'ja', 'ko': 'ko', 'auto': 'auto' } as Record<string,string>)[c] || c }
function detectLangForText(text: string): TargetLang | 'auto'{
  const s = text || ''
  const hasKo = /[\uac00-\ud7af]/.test(s)
  if (hasKo) return 'ko'
  const hasJa = /[\u3040-\u30ff]/.test(s) // „Å≤„Çâ„Åå„Å™/„Ç´„Çø„Ç´„Éä
  if (hasJa) return 'ja'
  const zhCount = (s.match(/[\u4e00-\u9fa5]/g) || []).length
  if (zhCount > Math.max(1, s.length * 0.15)) return 'zh-CN'
  return 'en'
}

// ======== ÊñáÊú¨ÈÄâÊã©ÁøªËØëÔºàÊÇ¨ÊµÆÂ∑•ÂÖ∑Ôºâ ========
const LANG_AUTONYMS: Array<{ code: TargetLang; label: string }> = [
  { code: 'zh-TW', label: 'ÁπÅÈ´î‰∏≠Êñá' },
  { code: 'zh-CN', label: 'ÁÆÄ‰Ωì‰∏≠Êñá' },
  { code: 'en', label: 'English' },
  { code: 'ko', label: 'ÌïúÍµ≠Ïñ¥' },
  { code: 'ja', label: 'Êó•Êú¨Ë™û' },
]
const translateLabel = computed(() => ({ 'zh-CN': 'ÁøªËØë', 'zh-TW': 'ÁøªË≠Ø', 'ja': 'ÁøªË®≥', 'ko': 'Î≤àÏó≠', 'en': 'Translate' }[locale.value as string] || 'Translate'))
const copyLabel = computed(() => ({ 'zh-CN': 'Â§çÂà∂', 'zh-TW': 'Ë§áË£Ω', 'ja': '„Ç≥„Éî„Éº', 'ko': 'Î≥µÏÇ¨', 'en': 'Copy' }[locale.value as string] || 'Copy'))
const closeLabel = computed(() => ({ 'zh-CN': 'ÂÖ≥Èó≠', 'zh-TW': 'ÈóúÈñâ', 'ja': 'Èñâ„Åò„Çã', 'ko': 'Îã´Í∏∞', 'en': 'Close' }[locale.value as string] || 'Close'))
const translatingLabel = computed(() => ({ 'zh-CN': 'ÁøªËØë‰∏≠‚Ä¶', 'zh-TW': 'ÁøªË≠Ø‰∏≠‚Ä¶', 'ja': 'ÁøªË®≥‰∏≠‚Ä¶', 'ko': 'Î≤àÏó≠ Ï§ë‚Ä¶', 'en': 'Translating‚Ä¶' }[locale.value as string] || 'Translating‚Ä¶'))
const failedLabel = computed(() => ({ 'zh-CN': 'ÁøªËØëÂ§±Ë¥•', 'zh-TW': 'ÁøªË≠ØÂ§±Êïó', 'ja': 'ÁøªË®≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'ko': 'Î≤àÏó≠ Ïã§Ìå®', 'en': 'Translate failed' }[locale.value as string] || 'Translate failed'))

// ÂºÄÂÖ≥ÔºöÁ¶ÅÁî®ÂèåÂáª/ÊñáÊú¨ÈÄâÊã©Ëß¶ÂèëÁöÑÁøªËØëÊµÆÂ±Ç
const ENABLE_SELECTION_TRANSLATE = false
const selOpen = ref(false)
const selLangOpen = ref(false)
const selResultOpen = ref(false)
const selLoading = ref(false)
const selPos = ref({ left: 0, top: 0 })
const selText = ref('')
const selResult = ref('')

function updateSelectionUI(){
  const sel = window.getSelection()
  if (!sel || sel.isCollapsed) { hideSelPanel(); return }
  const text = (sel.toString() || '').trim()
  if (!text) { hideSelPanel(); return }
  const range = sel.rangeCount ? sel.getRangeAt(0) : null
  if (!range) { hideSelPanel(); return }
  const rect = range.getBoundingClientRect()
  if (!rect || (rect.width === 0 && rect.height === 0)) { hideSelPanel(); return }
  selText.value = text
  selOpen.value = true
  selLangOpen.value = false
  selResultOpen.value = false
  selLoading.value = false
  const pad = 8
  const top = Math.max(8, rect.top + window.scrollY - 44 - pad)
  const left = Math.min(window.innerWidth - 200, Math.max(8, rect.left + rect.width/2 - 60))
  selPos.value = { left, top }
}

function hideSelPanel(){ selOpen.value = false; selLangOpen.value = false; selResultOpen.value = false; selLoading.value = false }
function toggleSelLangMenu(){ selLangOpen.value = !selLangOpen.value }
async function translateSelection(target: TargetLang){
  selLangOpen.value = false
  selResultOpen.value = true
  selLoading.value = true
  const t = await translateTextSafe(selText.value, 'auto', target)
  selResult.value = t || selText.value
  selLoading.value = false
}
function closeSelPanel(){ hideSelPanel() }
function copySelResult(){
  const txt = selResult.value || selText.value
  navigator.clipboard?.writeText(txt).then(()=>{ showToast(copyLabel.value) }).catch(()=>{})
}

function onSelMouseUp(){
  // ‰ªÖÂú®ËÅäÂ§©Âå∫ÂüüÈÄâÊã©Êó∂Â±ïÁ§∫ÔºàÂü∫Á°ÄÂà§Êñ≠Ôºâ
  const sel = window.getSelection()
  if (!sel || sel.isCollapsed){ hideSelPanel(); return }
  updateSelectionUI()
}
function onSelKeyUp(){ updateSelectionUI() }
if (ENABLE_SELECTION_TRANSLATE){
  window.addEventListener('mouseup', onSelMouseUp)
  window.addEventListener('keyup', onSelKeyUp)
}

// ======== Á§ºÁâ©ÂïÜÂüéÔºàÊ®°ÊÄÅÊ°ÜÔºâ ========
interface Gift { id: string; name: string; price: number; img: string }
const giftModalOpen = ref(false)
const giftLoading = ref(false)
const giftError = ref('')
const giftCatalog = ref<Gift[]>([])
// Á§ºÁâ©Ê∞îÊ≥°Èù¢ÊùøÔºà‰∏éË°®ÊÉÖÁ±ª‰ººÔºâ
const giftBtn = ref<HTMLElement | null>(null)
const giftPanelRef = ref<HTMLElement | null>(null)
const giftOpen = ref(false)

async function loadGiftCatalog(force = false){
  if (!force && giftCatalog.value.length) return
  giftLoading.value = true
  giftError.value = ''
  try{
    const { data } = await api.get('/api/gifts/catalog')
    giftCatalog.value = data?.list || []
  }catch{
    giftError.value = t('chat.toasts.sendFailed')
  }finally{
    giftLoading.value = false
  }
}

async function openGiftModal(){
  await loadGiftCatalog()
  giftModalOpen.value = true
}

function closeGiftModal(){
  giftModalOpen.value = false
}

async function sendGift(g: Gift){
  // ÂèëÈÄÅÁ§ºÁâ©ÈúÄË¶ÅÁôªÂΩïÊÄÅ
  const token = localStorage.getItem('token')
  if (!token){
  showToast(t('chat.toasts.loginBeforeGift'))
    // Âø´Êç∑Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
    window.setTimeout(()=>{ location.hash = '#/login' }, 800)
    return
  }
  // ÁõÆÊ†áÁî®Êà∑ ID
  const to = String(peerId.value || '')
  if (!to){ showToast(t('chat.toasts.choosePeer')); return }
  try{
    await api.post('/api/gifts/send', { toUserId: to, giftId: g.id })
    showToast(`Â∑≤ÈÄÅÂá∫„Äå${g.name}„Äç`)
    closeGiftModal()
  }catch(e:any){
  const msg = e?.response?.data?.error || t('chat.toasts.sendFailed')
    showToast(msg)
  }
}

function sendGiftAndClose(g: Gift){
  sendGift(g)
  closeGiftPanel()
}

function positionGiftPanel(anchor: HTMLElement){
  const panel = giftPanelRef.value
  if (!panel) return
  const a = anchor.getBoundingClientRect()
  const pad = 8
  panel.style.position = 'fixed'
  const w = panel.offsetWidth || 420
  const h = panel.offsetHeight || 360
  let left = a.left - (w - a.width)/2
  let top = a.top - h - 10
  left = Math.max(pad, Math.min(left, window.innerWidth - w - pad))
  // Ëã•‰∏äÊñπÊîæ‰∏ç‰∏ãÔºåÊîæÂà∞ÊåâÈíÆ‰∏ãÊñπ
  if (top < pad) top = Math.min(a.bottom + 10, window.innerHeight - h - pad)
  panel.style.left = `${left}px`
  panel.style.top = `${top}px`
}

function onDocClickCloseGift(ev: PointerEvent){
  const panel = giftPanelRef.value
  const btn = giftBtn.value
  const t = ev.target as Node
  if (!panel){ giftOpen.value = false; window.removeEventListener('pointerdown', onDocClickCloseGift, true); return }
  if (panel.contains(t) || (btn && btn.contains(t))) return
  giftOpen.value = false
  window.removeEventListener('pointerdown', onDocClickCloseGift, true)
}

async function toggleGift(e?: MouseEvent){
  e?.stopPropagation()
  const anchor = (e?.currentTarget as HTMLElement) || giftBtn.value
  if (!anchor) return
  if (giftOpen.value){
    giftOpen.value = false
    window.removeEventListener('pointerdown', onDocClickCloseGift, true)
    return
  }
  await loadGiftCatalog()
  giftOpen.value = true
  nextTick(() => {
    positionGiftPanel(anchor)
    window.addEventListener('pointerdown', onDocClickCloseGift, true)
  })
}

function closeGiftPanel(){
  giftOpen.value = false
  window.removeEventListener('pointerdown', onDocClickCloseGift, true)
}

function openGiftModalFromPanel(){
  closeGiftPanel()
  openGiftModal()
}

// Ë°®ÊÉÖÈÄâÊã©Âô®ÂºïÁî®‰∏éÂÆû‰æã
const emojiBtn = ref<HTMLElement | null>(null)
const msgInput = ref<HTMLTextAreaElement | null>(null)
let emojiPicker: any | null = null
const emojiOpen = ref(false)

function getEmojiPanelEl(): HTMLElement | null {
  return document.querySelector('.emoji-picker') as HTMLElement | null
}

// ‰ΩøÁî® pointerdown + ÊçïËé∑Èò∂ÊÆµÔºåÈò≤Ê≠¢ÊâìÂºÄÂêéÂêå‰∏ÄÊ¨° click Ëß¶ÂèëÂ§ñÈÉ®ÂÖ≥Èó≠
function onDocClickCloseEmoji(ev: PointerEvent){
  const panel = getEmojiPanelEl()
  const btn = emojiBtn.value
  const t = ev.target as Node
  if (!panel) { emojiOpen.value = false; removeEmojiOutsideGuard(); return }
  if (panel.contains(t) || (btn && btn.contains(t))) return
  // ÁÇπÂáªÂú®Â§ñÈÉ®ÔºöÂÖ≥Èó≠
  if (emojiPicker && typeof (emojiPicker as any).hidePicker === 'function') (emojiPicker as any).hidePicker()
  else panel.setAttribute('hidden', 'true')
  emojiOpen.value = false
  removeEmojiOutsideGuard()
}

function addEmojiOutsideGuard(){
  // ÈÅøÂÖçÈáçÂ§çÁªëÂÆö
  removeEmojiOutsideGuard()
  window.addEventListener('pointerdown', onDocClickCloseEmoji, true)
}
function removeEmojiOutsideGuard(){
  window.removeEventListener('pointerdown', onDocClickCloseEmoji, true)
}

onMounted(async () => {
  // ËøõÂÖ•ËÅäÂ§©È°µÊó∂Áªô body Âä†ËÉåÊôØÁ±ªÔºå‰ªÖÊú¨È°µÁîüÊïà
  // Âä®ÊÄÅÊãâÂèñÂêéÁ´ØÈÖçÁΩÆÁöÑËÅäÂ§©ËÉåÊôØÔºà‰ªÖÂêéÁ´ØÂèØÊéßÔºâ
  try {
    const ctrl = new AbortController()
    const timer = window.setTimeout(() => ctrl.abort(), 5000)
    const { data } = await api.get('/api/content/theme', { signal: ctrl.signal });
    window.clearTimeout(timer)
    const base = (api.defaults as any)?.baseURL || '';
    const fallback = String(base).replace(/\/$/, '') + '/static/backgrounds_1920_1080.jpg';
    const cfgUrl = data?.data?.chatBackground as string | undefined;
    const absUrl = cfgUrl && /^(https?:)?\/{2}/i.test(cfgUrl)
      ? cfgUrl
      : (String(base).replace(/\/$/, '') + (cfgUrl || '/static/backgrounds_1920_1080.jpg'));
    const el = document.getElementById('app-bg');
    if (el) el.setAttribute('style', `background:url('${absUrl || fallback}') center/cover no-repeat fixed;`);
    // Áõ¥Êé•‰ΩúÁî®‰∫é bodyÔºå‰øùËØÅÈÄèÊòéÂå∫ÂüüËÉΩÊòæÁ§∫ËÉåÊôØ
    document.body.style.background = `url('${absUrl || fallback}') center/cover no-repeat fixed`;
  } catch {
    // Â§±Ë¥•Áõ¥Êé•‰ΩøÁî®Êú¨Âú∞ÈùôÊÄÅËÉåÊôØ
    const el = document.getElementById('app-bg');
    const fallback = '/backgrounds/chat-bg.jpg'
    if (el) el.setAttribute('style', `background:url('${fallback}') center/cover no-repeat fixed;`);
    document.body.style.background = `url('${fallback}') center/cover no-repeat fixed`;
  }
  socket = getSocket();
  // ÈáçÊñ∞Ê≥®ÂÜåÁõëÂê¨ÂâçÔºåÂÖàÁßªÈô§ÊóßÁöÑÁõëÂê¨ÔºåÈÅøÂÖç HMR ÊàñÈáçÂ§çÊåÇËΩΩÈÄ†ÊàêÁöÑÈáçÂ§çÊé®ÈÄÅ
  socket.off('private:message');
  socket.on('private:message', (m: Message) => {
    if ((m.fromUserId === me.value && m.toUserId === peerId.value) || (m.fromUserId === peerId.value && m.toUserId === me.value)) {
      if (!seen.has(m.id)) {
        seen.add(m.id);
        messages.value.push(m);
        nextTick(() => scrollToBottom())
      }
    }
  });
  // Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØÔºöÊ∏∏ÂÆ¢‰ªÖÂÖÅËÆ∏ support ÂØπËØù
  if (isGuestSupport.value) {
    const { data } = await api.get(`/api/messages/${peerId.value}`, { headers: { 'x-guest-id': guestId.value } })
    messages.value = data
    data.forEach((m: Message) => seen.add(m.id))
    nextTick(() => scrollToBottom())
  } else {
    const { data } = await api.get(`/api/messages/${peerId.value}`)
    messages.value = data
    data.forEach((m: Message) => seen.add(m.id))
    nextTick(() => scrollToBottom())
  }
  const meId = localStorage.getItem('uid');
  if (meId) me.value = meId;
  // Âä†ËΩΩÂèåÊñπÊÄßÂà´‰ª•ÂêØÁî®ÈªòËÆ§Â§¥ÂÉèÔºàÊ∏∏ÂÆ¢Êó∂‰ªÖÈúÄÂØπÊñπÔºâ
  await loadGenders();
  // ÊêúÁ¥¢È°µÁ≠æÔºöÂàùÂßãÂåñÊúÄËøë‰ºöËØù
  if (!isSupportSimple.value) {
    fetchRecent();
    preloadUsers();
  }
  // ËøõÂÖ•ËÅäÂ§©È°µÂç≥Ê†áËÆ∞ËØ•‰ºöËØù‰∏∫Â∑≤ËØªÔºàÁôªÂΩïÊÄÅÔºâ
  if (!isGuestSupport.value && peerId.value) {
    api.post('/api/messages/read', { peerId: peerId.value }).then(()=>{
      // ÈÄöÁü•ÂÖ∂‰ªñÈ°µÈù¢Âà∑Êñ∞‰ºöËØùÊú™ËØª
      window.dispatchEvent(new Event('conv-read'))
    }).catch(()=>{})
  }

  // Ëã•Á¶ÅÁî®Á¨¨‰∏âÊñπÈÄâÊã©Âô®ÔºåÊ∏ÖÁêÜ‰ªª‰ΩïÊÆãÁïô DOMÔºåÂπ∂Ê≥®ÂÖ•ÈöêËóèÊ†∑Âºè‰ª•ÈÅøÂÖçËØØÊòæ
  if (!USE_EMOJI_BUTTON) {
    cleanupThirdPartyEmojiPanels()
    injectHideEmojiCss()
  } else {
    // È¢ÑÁÉ≠Âä®ÊÄÅÂØºÂÖ•ÔºàËã•Â§±Ë¥•‰∏ç‰ºöÈòªÂ°ûÔºåÈ¶ñÊ¨°ÁÇπÂáªÊó∂Ëøò‰ºöÂÜçÂ∞ùËØïÔºâ
    try { await import('emoji-button') } catch {}
  }

  // ÂàùÂßãÂåñËæìÂÖ•È´òÂ∫¶
  nextTick(()=> autoResize())
});

onUnmounted(() => {
  // Ê∏ÖÁêÜÂ∫îÁî®Á∫ßËÉåÊôØÊ†∑Âºè
  const el = document.getElementById('app-bg');
  if (el) el.removeAttribute('style');
  document.body.style.background = '';
  socket?.disconnect();
  window.removeEventListener('keydown', onEscClose)
  window.removeEventListener('click', onDocClickCloseLang)
  removeEmojiOutsideGuard()
  if (ENABLE_SELECTION_TRANSLATE){
    window.removeEventListener('mouseup', onSelMouseUp)
    window.removeEventListener('keyup', onSelKeyUp)
  }
  cleanupThirdPartyEmojiPanels()
  removeHideEmojiCss()
});

async function ensureEmojiPicker(){
  if (emojiPicker) return emojiPicker
  try{
    const mod: any = await import('emoji-button')
    EmojiButton = (mod as any).EmojiButton || (mod as any).default
    emojiPicker = new EmojiButton({
      theme: 'light',
      position: 'top-start',
      autoFocusSearch: true,
      showVariants: false,
      emojisPerRow: 8,
      zIndex: 10000,
      rootElement: document.body,
      i18n: { search: 'ÊêúÁ¥¢', categories: { recents: 'Â∏∏Áî®', smileys: 'Ë°®ÊÉÖ', people: '‰∫∫Áâ©', animals: 'Âä®Áâ©', foods: 'È£üÁâ©', travel: 'ÊóÖË°å', activities: 'Ê¥ªÂä®', objects: 'Áâ©ÂìÅ', symbols: 'Á¨¶Âè∑', flags: 'ÊóóÂ∏ú' } }
    })
    emojiPicker.on('emoji', (selection: any) => {
      const ch = selection?.emoji ?? selection
      if (typeof ch === 'string') insertAtCaret(ch); else insertAtCaret(selection.emoji)
    })
    // ÂêåÊ≠•Â±ïÁ§∫Áä∂ÊÄÅÔºåËá™Âä®ÊåÇ/Âç∏Â§ñÈÉ®ÁÇπÂáªÁõëÂê¨
    const onShown = () => { emojiOpen.value = true; addEmojiOutsideGuard() }
    const onHidden = () => { emojiOpen.value = false; removeEmojiOutsideGuard() }
    ;(emojiPicker as any).on?.('show', onShown)
    ;(emojiPicker as any).on?.('hidden', onHidden)
    return emojiPicker
  }catch(err){
    // ‰∫§Áî±Ë∞ÉÁî®ÊñπÂÖúÂ∫ï
    throw err
  }
}

function isEmojiPanelVisible(picker?: any){
  // ‰ºòÂÖà‰ΩøÁî®Â∫ìËá™Â∏¶ÁöÑÊ†áÂøó‰ΩçÔºà‰∏çÂêåÁâàÊú¨Â≠óÊÆµÊàñÂáΩÊï∞ÂêçÂèØËÉΩ‰∏çÂêåÔºâ
  if (picker){
    const v: any = (picker as any).isPickerVisible ?? (picker as any).pickerVisible ?? (picker as any).visible
    if (typeof v === 'function') {
      try { return !!v.call(picker) } catch { /* ignore */ }
    }
    if (typeof v === 'boolean') return v
  }
  const panel = document.querySelector('.emoji-picker') as HTMLElement | null
  if (!panel) return false
  if (panel.hasAttribute('hidden')) return false
  const style = window.getComputedStyle(panel)
  if (style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity || '1') === 0) return false
  const rects = panel.getClientRects()
  return rects && rects.length > 0 && rects[0].width > 0 && rects[0].height > 0
}

async function toggleEmoji(e?: MouseEvent){
  // ÈòªÊ≠¢Êú¨Ê¨°ÁÇπÂáªÂÜíÊ≥°Âà∞ documentÔºåÈÅøÂÖçÂàöÊâìÂºÄÂ∞±Ë¢´‚ÄúÂ§ñÈÉ®ÁÇπÂáª‚ÄùÈÄªËæëÂÖ≥Èó≠
  e?.stopPropagation()
  const anchor = (e?.currentTarget as HTMLElement) || emojiBtn.value
  if (!anchor) return
  // ÈááÁî®ÂÜÖÁΩÆÊú¨Âú∞Èù¢Êùø‰∏∫‰∏ªÔºåÁ°Æ‰øùË∑®ÁéØÂ¢ÉÁ®≥ÂÆö
  if (!USE_EMOJI_BUTTON){
    // ‰øùÂÆàÂ§ÑÁêÜÔºöÊòæÁ§∫ÂÜÖÁΩÆÈù¢ÊùøÂâçÔºåÊ∏Ö‰∏ÄÊ¨°Á¨¨‰∏âÊñπÊÆãÁïô
    cleanupThirdPartyEmojiPanels()
    if (localEmojiPanel) { hideLocalEmojiFallback(); return }
    showLocalEmojiFallback(anchor)
    return
  }
  // Â¶ÇÊûúÊú¨Âú∞ÂÖúÂ∫ïÈù¢ÊùøÂ∑≤ÊòæÁ§∫ÔºåÂàô‰ºòÂÖàÂÖ≥Èó≠Âπ∂ËøîÂõû
  if (localEmojiPanel) { hideLocalEmojiFallback(); return }
  try{
    const picker = await ensureEmojiPicker()
    const visible = emojiOpen.value || isEmojiPanelVisible(picker)
    if (visible) {
      if (typeof (picker as any).hidePicker === 'function') (picker as any).hidePicker()
      else if (typeof (picker as any).closePicker === 'function') (picker as any).closePicker()
      else (picker as any).togglePicker?.(anchor)
      emojiOpen.value = false
      removeEmojiOutsideGuard()
    } else {
      // ‰ΩøÁî® setTimeout Êé®ËøüÂà∞‰∫ã‰ª∂Âæ™ÁéØÂêéÊâßË°åÔºåÈÅøÂÖçÂêå‰∏ÄÊ¨° click Ë¢´Â§ñÈÉ®ÁÇπÂáª‰æ¶Âê¨Âô®ËØØÂà§
      window.setTimeout(() => {
        if (typeof (picker as any).openPicker === 'function') (picker as any).openPicker(anchor)
        else if (typeof (picker as any).showPicker === 'function') (picker as any).showPicker(anchor)
        else (picker as any).togglePicker?.(anchor)
        window.setTimeout(() => {
          ensurePanelInViewport(anchor)
        }, 60)
        emojiOpen.value = true
        // ÊçïËé∑Èò∂ÊÆµÁõëÂê¨Ôºå‰ºòÂÖà‰∫éÂ∫ìÂÜÖÈÉ®ÁöÑÂÜíÊ≥°ÂÖ≥Èó≠ÈÄªËæëÂ§ÑÁêÜ
        addEmojiOutsideGuard()
        // Ëã•Áü≠Êó∂Èó¥ÂÜÖ‰ªçÊú™ÂèØËßÅÔºåÂàôËá™Âä®ÂêØÁî®Êú¨Âú∞ÂÖúÂ∫ïÈù¢Êùø
        window.setTimeout(() => {
          const nowVisible = isEmojiPanelVisible(picker)
          if (!nowVisible){
            // ÂÖ≥Èó≠Á¨¨‰∏âÊñπÔºàËã•Â∑≤ÁªèÂàõÂª∫‰∫ÜÂç†‰ΩçÂ±ÇÔºâÂπ∂ÂàáÂà∞Êú¨Âú∞Èù¢Êùø
            try{ (picker as any).hidePicker?.() }catch{}
            removeEmojiOutsideGuard()
            showLocalEmojiFallback(anchor)
          }
        }, 180)
      }, 0)
    }
  }catch{
    // Â¶ÇÊûúÁ¨¨‰∏âÊñπÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåÂàô‰ΩøÁî®Êú¨Âú∞ÁÆÄÊòìË°®ÊÉÖÈù¢ÊùøÔºåÂπ∂ÊîØÊåÅ toggle
    if (localEmojiPanel) { hideLocalEmojiFallback(); return }
    showLocalEmojiFallback(anchor)
  }
}

// ========== ÂäüËÉΩÊú™Ëß£ÈîÅÊèêÁ§∫ ==========
function showToast(msg: string, key = 'toast-locked'){
  // ÁßªÈô§Âêå key ÁöÑÊóßÊèêÁ§∫ÔºåÈÅøÂÖçÂè†Âä†
  const old = document.getElementById(key)
  if (old && old.parentElement) old.parentElement.removeChild(old)
  const el = document.createElement('div')
  el.id = key
  el.textContent = msg
  Object.assign(el.style, {
    position: 'fixed', left: '50%', bottom: '84px', transform: 'translateX(-50%)',
    background: 'rgba(17,24,39,0.92)', color: '#fff',
    padding: '10px 14px', borderRadius: '999px',
    fontSize: '14px', fontWeight: '700', letterSpacing: '0.5px',
    boxShadow: '0 8px 20px rgba(0,0,0,.25)', zIndex: '10000',
    maxWidth: '80%', whiteSpace: 'nowrap'
  } as CSSStyleDeclaration)
  document.body.appendChild(el)
  window.setTimeout(() => {
    el.style.transition = 'opacity .25s ease, transform .25s ease'
    el.style.opacity = '0'
    el.style.transform = 'translateX(-50%) translateY(8px)'
    window.setTimeout(() => { if (el.parentElement) el.parentElement.removeChild(el) }, 260)
  }, 1400)
}

function onImageClick(ev?: MouseEvent){
  ev?.preventDefault()
  showToast(t('chat.toasts.notUnlocked'))
}

// ÊîØÊåÅÊåâ ESC ÂÖ≥Èó≠Á¨¨‰∏âÊñπË°®ÊÉÖÈù¢Êùø‰∏éÂÖúÂ∫ïÈù¢Êùø
function onEscClose(e: KeyboardEvent){
  if (e.key !== 'Escape') return
  const panel = document.querySelector('.emoji-picker') as HTMLElement | null
  if (panel && isEmojiPanelVisible()){
    // Â∞ùËØïÈÄöËøá picker API ÂÖ≥Èó≠
    if (emojiPicker && typeof (emojiPicker as any).hidePicker === 'function') (emojiPicker as any).hidePicker()
    else panel.setAttribute('hidden', 'true')
    emojiOpen.value = false
    removeEmojiOutsideGuard()
  }
  // ÂÖ≥Èó≠Á§ºÁâ©ÂºπÁ™ó
  if (giftModalOpen.value) giftModalOpen.value = false
  // ÂÖ≥Èó≠ËØ≠Ë®ÄËèúÂçï
  if (langMenuOpen.value) langMenuOpen.value = false
  if (localEmojiPanel) hideLocalEmojiFallback()
}
window.addEventListener('keydown', onEscClose)

// ======== Êú¨Âú∞ÁÆÄÊòìË°®ÊÉÖÈù¢ÊùøÔºàÂÖúÂ∫ïÔºâ ========
let localEmojiPanel: HTMLElement | null = null
// Êâ©ÂÖÖÂΩìÂâçÂ∏∏Áî®/ÁÉ≠Èó®Ë°®ÊÉÖÈõÜÂêà
const BASIC_EMOJIS = [
  'üòÄ','üòÅ','üòÇ','ü§£','ü•≤','ü•π','ü•≥','üòä','üòç','ü•∞','üòò','üòú','üòé','üôÇ','üôÉ','ü§î','ü§Ø','ü§ó','üòè','üò¥','üò¢','üò≠','üò°',
  'üëç','üëé','üëè','üôè','üí™','‚ù§Ô∏è','üíñ','üíó','‚ú®','üî•','üíØ','‚úÖ','‚ùå','üëÄ','üéâ','üéÅ','üì∏','üìå','üìç','üöÄ','üçÄ','üçª','‚òï','üçî','üçï','‚öΩ','üèÄ'
]
function showLocalEmojiFallback(anchor: HTMLElement){
  hideLocalEmojiFallback()
  const rect = anchor.getBoundingClientRect()
  const panel = document.createElement('div')
  panel.className = 'mini-emoji-fallback'
  Object.assign(panel.style, {
    position: 'fixed',
    left: `${rect.left}px`,
    top: `${rect.top - 240}px`,
    width: '320px',
    padding: '8px',
    background: '#fff',
    border: '1px solid rgba(17,24,39,0.08)',
    borderRadius: '12px',
    boxShadow: '0 10px 30px rgba(0,0,0,.15)',
    zIndex: '10000'
  } as CSSStyleDeclaration)
  const grid = document.createElement('div')
  Object.assign(grid.style, { display:'grid', gridTemplateColumns:'repeat(8,1fr)', gap:'6px' })
  BASIC_EMOJIS.forEach(ch => {
    const btn = document.createElement('button')
    btn.type = 'button'
    btn.textContent = ch
    Object.assign(btn.style, { width:'32px', height:'32px', borderRadius:'8px', border:'1px solid #e5e7eb', background:'#fff', cursor:'pointer' })
    btn.onmouseenter = () => { btn.style.background = '#f3f4f6' }
    btn.onmouseleave = () => { btn.style.background = '#fff' }
    btn.onclick = () => { insertAtCaret(ch); hideLocalEmojiFallback() }
    grid.appendChild(btn)
  })
  panel.appendChild(grid)
  document.body.appendChild(panel)
  localEmojiPanel = panel
  clampPanelToViewport(panel, rect)
  // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
  const onDocClick = (ev: MouseEvent) => {
    if (!panel.contains(ev.target as Node) && ev.target !== anchor){
      hideLocalEmojiFallback(); document.removeEventListener('click', onDocClick)
    }
  }
  window.setTimeout(()=> document.addEventListener('click', onDocClick), 0)
}
function hideLocalEmojiFallback(){
  if (localEmojiPanel && localEmojiPanel.parentElement){ localEmojiPanel.parentElement.removeChild(localEmojiPanel) }
  localEmojiPanel = null
}

// Â∞ÜÂºπÂ±ÇÈôêÂà∂Âà∞ËßÜÂè£ËåÉÂõ¥ÂÜÖÔºàÁ¨¨‰∏âÊñπÊàñÊú¨Âú∞Èù¢ÊùøÂùáÂèØÂ§çÁî®Ôºâ
function ensurePanelInViewport(anchor: HTMLElement){
  const panel = document.querySelector('.emoji-picker') as HTMLElement | null
  if (!panel) return
  const a = anchor.getBoundingClientRect()
  panel.style.position = 'fixed'
  // ÂàùÊ≠•ÊîæÂú®ÊåâÈíÆ‰∏äÊñπ
  let left = a.left
  let h = (panel.offsetHeight || 280)
  let w = (panel.offsetWidth || 320)
  let top = a.top - h - 8
  const pad = 8
  const maxLeft = window.innerWidth - w - pad
  const maxTop = window.innerHeight - h - pad
  left = Math.max(pad, Math.min(left, maxLeft))
  // ÈÅøÂÖçÈÅÆÊå°Â∫ïÈÉ®Ê∂àÊÅØÂèëÈÄÅÊù°
  const bar = document.querySelector('.chat-input') as HTMLElement | null
  if (bar){
    const br = bar.getBoundingClientRect()
    const idealTop = br.top - h - 8
    if (idealTop > pad){
      top = idealTop
    } else if (top < pad) {
      // ÂÆûÂú®Êîæ‰∏ç‰∏ãÂÜçÊîæÂà∞Â∑•ÂÖ∑Êù°‰∏ãÊñπÔºàÈÄöÂ∏∏Â∑≤Êé•ËøëËßÜÂè£Â∫ïÈÉ®ÔºâÔºåÂπ∂Â∞ΩÈáèË¥¥Â∫ï‰ΩÜ‰∏çÈÅÆÊå°
      top = Math.min(br.bottom + 8, maxTop)
    }
  } else if (top < pad) {
    top = Math.min(a.bottom + 8, maxTop)
  }
  panel.style.left = `${left}px`
  panel.style.top = `${top}px`
}

function clampPanelToViewport(panel: HTMLElement, anchorRect: DOMRect){
  const pad = 8
  const w = panel.offsetWidth || 320
  const h = panel.offsetHeight || 280
  let left = parseFloat(panel.style.left || `${anchorRect.left}`)
  let top = parseFloat(panel.style.top || `${anchorRect.top - h - 8}`)
  const maxLeft = window.innerWidth - w - pad
  const maxTop = window.innerHeight - h - pad
  left = Math.max(pad, Math.min(left, maxLeft))
  // ÈÅøÂÖçÈÅÆÊå°Â∫ïÈÉ®Ê∂àÊÅØÂèëÈÄÅÊù°
  const bar = document.querySelector('.chat-input') as HTMLElement | null
  if (bar){
    const br = bar.getBoundingClientRect()
    const idealTop = br.top - h - 8
    if (idealTop > pad){
      top = idealTop
    } else if (top < pad) {
      top = Math.min(br.bottom + 8, maxTop)
    }
  } else if (top < pad) {
    top = Math.min(anchorRect.bottom + 8, maxTop)
  }
  panel.style.left = `${left}px`
  panel.style.top = `${top}px`
}

function insertAtCaret(text: string){
  const input = msgInput.value as HTMLTextAreaElement | null
  if (!input){ content.value += text; return }
  const start = input.selectionStart ?? input.value.length
  const end = input.selectionEnd ?? input.value.length
  const before = input.value.slice(0, start)
  const after = input.value.slice(end)
  const newVal = before + text + after
  content.value = newVal
  nextTick(()=>{
    input.focus()
    const pos = start + text.length
    input.setSelectionRange(pos, pos)
    autoResize()
  })
}

function autoResize(){
  const el = msgInput.value
  if (!el) return
  el.style.height = 'auto'
  const h = Math.min(el.scrollHeight, 140)
  el.style.height = h + 'px'
}

function onEnterSend(e: KeyboardEvent){
  // ÂçïÁ∫Ø Enter Áõ¥Êé•ÂèëÈÄÅÔºõShift+Enter Âú®Ê®°Êùø‰∏äÂ∑≤ stop ‰Ωú‰∏∫Êç¢Ë°å
  send()
  // ÂèëÈÄÅÂêéÈáçÁΩÆÈ´òÂ∫¶
  nextTick(()=> autoResize())
}

// ======== Ê∏ÖÁêÜÁ¨¨‰∏âÊñπ emoji-button ÊÆãÁïôÈù¢Êùø & Âä®ÊÄÅÈöêËóèÊ†∑Âºè ========
function cleanupThirdPartyEmojiPanels(){
  try{
    const nodes = document.querySelectorAll('.emoji-picker')
    nodes.forEach(n => n.parentElement?.removeChild(n))
  }catch{}
}
function injectHideEmojiCss(){
  const id = 'hide-emoji-picker-css'
  if (document.getElementById(id)) return
  const style = document.createElement('style')
  style.id = id
  style.textContent = `.emoji-picker{display:none!important;}`
  document.head.appendChild(style)
}
function removeHideEmojiCss(){
  const el = document.getElementById('hide-emoji-picker-css')
  if (el && el.parentElement) el.parentElement.removeChild(el)
}

async function send() {
  if (!content.value || !content.value.trim()) return;
  // ÂèëÈÄÅÂâçÁßªÈô§ÂçäËßí/ÂÖ®ËßíÁ©∫Ê†ºÔºåÈò≤ÁªïËøáÔºõÂâçÁ´ØÂ§ÑÁêÜ‰∏ÄÊ¨°ÔºåÂêéÁ´Ø‰πü‰ºöÂÜçÊ¨°Ê†°È™å
  const cleaned = content.value.replace(/[ \u3000]+/g, '');
  if (!cleaned) { content.value = ''; return; }
  const token = localStorage.getItem('token');
  // Êú™ÁôªÂΩï‰∏îÈùûÂÆ¢Êúç‰ºöËØùÔºöÁ¶ÅÊ≠¢ÂèëÈÄÅÔºåÊèêÁ§∫ÂéªÁôªÂΩï
  if (!token && peerId.value !== 'support') {
    showToast(t('nav.login'));
    window.setTimeout(() => { location.hash = '#/login' }, 800);
    return;
  }
  if (isGuestSupport.value) {
    // Ê∏∏ÂÆ¢ÈÄöËøá HTTP fallback ÂèëÈÄÅ
    const { data } = await api.post('/api/messages/guest/support', { guestId: guestId.value, content: cleaned })
    if (!seen.has(data.id)) { seen.add(data.id); messages.value.push(data); }
  } else {
    // ‰ºòÂÖàÈÄöËøá Socket ÂèëÈÄÅÔºõËã•Êú™ËøûÊé•ÔºåÂàôËµ∞ HTTP fallbackÔºåÁ°Æ‰øùÂèØ‰ª•ÂèëÂá∫
    if (socket && (socket as any).connected) {
      socket.emit('private:message', { toUserId: peerId.value, content: cleaned });
    } else {
      try {
        const { data } = await api.post('/api/messages', { toUserId: String(peerId.value || ''), content: cleaned })
        if (!seen.has(data.id)) { seen.add(data.id); messages.value.push(data); }
      } catch (e: any) {
        const msg = e?.response?.data?.error || 'ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï'
        showToast(msg)
        return;
      }
    }
    // ‰∏çÂÜçËøõË°åÊú¨Âú∞‰πêËßÇËøΩÂä†ÔºåÈÅøÂÖç‰∏éÊúçÂä°Âô®ÂõûÊòæÁöÑÂêå‰∏ÄÊù°Ê∂àÊÅØÈáçÂ§çÊòæÁ§∫
  }
  content.value = '';
  nextTick(() => scrollToBottom())
}

// Ëá™Âä®ÊªöÂä®Âà∞ÊúÄÊñ∞Ê∂àÊÅØ
const chatBody = ref<HTMLElement | null>(null)
function scrollToBottom(){
  const el = chatBody.value
  if (!el) return
  el.scrollTop = el.scrollHeight
}
watch(messages, () => nextTick(() => scrollToBottom()))

// ÂΩìÂàáÊç¢ËØ≠Ë®ÄÊàñÊñ∞Ê∂àÊÅØÂà∞ËææÊó∂ÔºåËá™Âä®ÁøªËØëÊúÄËøëÁöÑÊ∂àÊÅØÔºàÊúÄÂ§ö 30 Êù°Ôºâ
watch([messages, langTarget], async () => {
  if (!langTarget.value) return
  const source = guessSourceLang()
  const recent = messages.value.slice(-30)
  const todo = recent.map(m => ({ m, key: `${m.id}|${langTarget.value}` })).filter(it => !translateCache.has(it.key))
  if (!todo.length) return
  await runPool(todo, 6, async (it) => {
    const t = await translateTextSafe(it.m.content, source as any, langTarget.value as any)
    if (t) { translateCache.set(it.key, t); translateVersion.value++ }
    else { if (typeof translateFailed !== 'undefined') translateFailed.add(it.key); translateVersion.value++ }
    return null as any
  })
}, { deep: true })

// Êñ∞Ê∂àÊÅØÂà∞ËææÊó∂ÔºåËã•Â∑≤ÈÄâÊã©ÂÖ®Â±ÄËØ≠Ë®ÄÔºå‰ºòÂÖàÂø´ÈÄüÁøªËØëÊúÄÂêé‰∏ÄÊù°ÔºåÈÅøÂÖç‚ÄúÂàöÂèëÂá∫ÁöÑÊ∂àÊÅØ‰∏çÁøªËØë‚ÄùÁöÑÁ©∫Á™ó
watch(() => messages.value.length, async (len, old) => {
  if (!langTarget.value) return
  if (len <= 0 || len <= (old || 0)) return
  const m = messages.value[len - 1]
  if (!m) return
  const key = `${m.id}|${langTarget.value}`
  if (translateCache.has(key)) return
  // Á´ãÂàªËß¶Âèë‚ÄúÁøªËØë‰∏≠‚Ä¶‚ÄùÊ∏≤Êüì
  translateVersion.value++
  const src = detectLangForText(m.content)
  const sNorm = normLang(src)
  const tNorm = normLang(langTarget.value)
  const t = (sNorm === tNorm) ? m.content : await translateTextSafe(m.content, src as any, langTarget.value as any)
  if (t) { translateCache.set(key, t); translateVersion.value++ }
  else { if (typeof translateFailed !== 'undefined') translateFailed.add(key); translateVersion.value++ }
})

// ÊñáÊú¨ÂÜÖÂÆπÂèòÂåñÊó∂‰πüË∞ÉÊï¥È´òÂ∫¶ÔºàÂåÖÊã¨Â§ñÈÉ®ÊèíÂÖ•Ë°®ÊÉÖÔºâ
watch(content, () => nextTick(()=> autoResize()))

// Ë∑ØÁî±ÂàáÊç¢Êó∂ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤‰∏éÊÄßÂà´Á≠â
async function loadHistory(){
  messages.value = []
  seen.clear()
  try{
    if (isGuestSupport.value) {
      const { data } = await api.get(`/api/messages/${peerId.value}`, { headers: { 'x-guest-id': guestId.value } })
      messages.value = data
      data.forEach((m: Message) => seen.add(m.id))
    } else {
      const { data } = await api.get(`/api/messages/${peerId.value}`)
      messages.value = data
      data.forEach((m: Message) => seen.add(m.id))
    }
  } finally {
    nextTick(() => scrollToBottom())
  }
}

async function loadGenders(){
  try {
    const token = localStorage.getItem('token');
    if (token) {
      const [{ data: meUser }, { data: users }] = await Promise.all([
        api.get('/api/users/me'),
        api.get('/api/users')
      ])
      myGender.value = (meUser.gender || 'other') as Gender
      me.value = (meUser.id || localStorage.getItem('uid') || me.value || '') as string
      const peer = Array.isArray(users) ? users.find((u: any) => u.id === peerId.value) : null
      peerGender.value = (peer?.gender || 'other') as Gender
      peerNickname.value = peer?.nickname || ''
    } else {
      // Ê∏∏ÂÆ¢ÔºöÊó†ËÆ∫ÊòØÂê¶‰∏éÂÆ¢Êúç‰ºöËØùÔºåÈÉΩËÆæÁΩÆ‰∏¥Êó∂ uidÔºå‰øùËØÅ socket ÂõûÊòæÂåπÈÖç
      const { data: users } = await api.get('/api/users')
      const isSupport = peerId.value === 'support'
      const pid = isSupport ? 'support' : peerId.value
      const peer = Array.isArray(users) ? users.find((u: any) => u.id === pid) : null
      peerGender.value = (peer?.gender || 'other') as Gender
      myGender.value = 'other'
      me.value = `guest:${guestId.value}`
      if (isSupport) peerNickname.value = ''
    }
  } catch {}
}

// ========== ÊêúÁ¥¢‰∏éÊúÄËøë‰ºöËØù ==========
type UserLite = { id: string; nickname?: string; gender?: Gender }
const activeTab = ref<'search'|'chat'>('chat')
const searchKey = ref('')
const searching = ref(false)
const allUsers = ref<UserLite[]>([])
const searchResults = ref<UserLite[]>([])
const recentList = ref<Array<{ peerId: string; lastAt: number; lastContent: string; unread: number; peer: UserLite }>>([])

async function preloadUsers(){
  try{
    const { data } = await api.get('/api/users')
    const list = Array.isArray(data) ? data : []
    // ËøáÊª§ÊéâËá™Â∑±‰∏éÂÆ¢ÊúçË¥¶Âè∑
    const my = localStorage.getItem('uid')
    allUsers.value = list.filter((u:any)=> u && u.id && u.id !== my && u.id !== 'support')
  }catch{}
}

async function fetchRecent(){
  try{
    const { data } = await api.get('/api/messages/recent')
    recentList.value = data?.list || []
  }catch{}
}

function normalize(s:string){ return (s||'').toLowerCase() }
let searchTimer:number|undefined
function onSearchInput(){
  if (searchTimer) window.clearTimeout(searchTimer)
  searchTimer = window.setTimeout(doSearch, 200)
}
function doSearch(){
  const key = normalize(searchKey.value)
  if (!key){ searchResults.value = []; return }
  searching.value = true
  // Êú¨Âú∞ËøáÊª§ÔºàÂ¶ÇÈúÄÂèØÂàáÊç¢‰∏∫ÊúçÂä°Á´ØÊ®°Á≥äÊü•ËØ¢Ôºâ
  const res = allUsers.value.filter(u => normalize(u.nickname||u.id).includes(key)).slice(0, 20)
  searchResults.value = res
  searching.value = false
}
function openChatWith(uid: string){
  activeTab.value = 'chat'
  // Ë∑≥ËΩ¨Âà∞ËØ•Áî®Êà∑‰ºöËØù
  window.setTimeout(()=>{ location.hash = '#/chat/' + encodeURIComponent(uid) }, 0)
}

function isToday(ts:number){ const d=new Date(ts); const n=new Date(); return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate() }
function isYesterday(ts:number){ const n=new Date(); const y=new Date(n.getFullYear(), n.getMonth(), n.getDate()-1); const d=new Date(ts); return d.getFullYear()===y.getFullYear() && d.getMonth()===y.getMonth() && d.getDate()===y.getDate() }
function formatTime(ts:number){ const d=new Date(ts); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${m}-${day}` }
function formatRelative(ts:number){ if(isToday(ts)) return t('chat.time.today'); if(isYesterday(ts)) return t('chat.time.yesterday'); return formatTime(ts) }

watch(() => route.params.id, async () => {
  await Promise.all([loadHistory(), loadGenders()])
  // ÂàáÊç¢‰ºöËØùÊó∂‰πüÊ†áËÆ∞Â∑≤ËØª
  if (!isGuestSupport.value && peerId.value) {
    api.post('/api/messages/read', { peerId: peerId.value }).then(()=>{
      window.dispatchEvent(new Event('conv-read'))
    }).catch(()=>{})
  }
  // ÂàáÊç¢Âà∞Êüê‰∏™‰ºöËØùÂêéÔºåËá™Âä®ÂàáÂõûËÅäÂ§©È°µÁ≠æ
  activeTab.value = 'chat'
})

// ====== Ë∑®È°µËÅîÂä®ÔºöLucky ÊàñÂÖ∂‰ªñÈ°µÈù¢ÂèØÈÄöËøáÂÖ®Â±ÄÂáΩÊï∞Âî§Ëµ∑‰ºöÂëòÂºπÁ™ó ======
function openVipNow(){
  const fn = (window as any).__openVipModal
  if (typeof fn === 'function') fn()
  else router.push('/settings')
}
</script>

<style scoped>
/* ÂÖÖÊª°ËßÜÂè£ÁöÑÂõ∫ÂÆöËÉåÊôØÂ±Ç */
.chat-bg{ background: url('/backgrounds/chat-bg.jpg') center/cover no-repeat fixed; }
.chat-body{ background: radial-gradient(1200px 600px at 50% 0%, rgba(255,255,255,.65), rgba(255,255,255,.45)); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); }
.chat-input{ background: rgba(255,255,255,0.68); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

/* Ê†áÁ≠æÊù°Ê†∑ÂºèÔºàÂèÇËÄÉËçâÂõæÔºâ */
.tab-bar{ display:flex; gap:0; border-bottom:1px solid #e5e7eb; }
.tab{ padding:10px 14px; font-weight:700; color:#6b7280; border-right:1px solid #e5e7eb; cursor:pointer; user-select:none; }
.tab:hover{ background:#f9fafb; }
.tab.active{ color:#111827; position:relative; }
.tab.active::after{ content:""; position:absolute; left:0; right:0; bottom:-1px; height:3px; background: var(--brand-main, #e67a88); }

/* Â∫ïÈÉ®Â∑•ÂÖ∑ÂúÜÊåâÈíÆ‰∏éÂèëÈÄÅ */
.circle-icon{ width:36px; height:36px; border-radius:50%; border:1.5px solid #e5e7eb; display:grid; place-items:center; background:#fff; font-size:14px; box-shadow:0 2px 6px rgba(0,0,0,.06); }
.circle-icon:hover{ background:#f9fafb; }
.send-btn{ background: var(--brand-main, #e67a88); color:#fff; font-weight:800; border:2px solid rgba(255,255,255,.5); box-shadow:0 6px 16px rgba(230,122,136,.35); }

/* emoji-button ËΩªÊ†∑ÂºèÈÄÇÈÖç */
:global(.emoji-picker){ box-shadow: 0 10px 30px rgba(0,0,0,.15); border-radius:12px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
.send-btn:hover{ filter: brightness(1.06); }

/* Êñ∞ÔºöÂ±Ö‰∏≠ÊÇ¨ÊµÆËæìÂÖ•Ê∞îÊ≥°ÔºàÊõ¥ËÅöÁÑ¶Ôºâ */
.composer{ max-width: 920px; margin: 0 auto; display:flex; align-items:center; gap:10px; padding:6px; border-radius:999px; background:#fff; border:1px solid #e5e7eb; box-shadow:0 6px 20px rgba(0,0,0,.06); }
.composer:focus-within{ box-shadow:0 10px 26px rgba(0,0,0,.10); border-color:#e4e4e7; }
.composer input::placeholder{ color:#b8bcc3; }

/* ËØ≠Ë®ÄËèúÂçïÔºàÂ∫ïÈÉ®Êõ¥Â§öÊåâÈíÆÔºâ */
.lang-menu{ background:#fff; color:#111; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.14); padding:8px; width:180px; z-index:10010; }
.lang-menu .tip{ position:absolute; bottom:-7px; right:12px; width:14px; height:14px; background:#fff; border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; transform:rotate(45deg); }
.lang-menu .group-title{ font-size:12px; color:#64748b; font-weight:800; padding:4px 10px 6px; }
.lang-menu .menu-item{ width:100%; text-align:left; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:8px; font-weight:800; color:#111; }
.lang-menu .menu-item:hover{ background:#f9fafb; }
.lang-menu .menu-item.active{ background:#fff5f7; color: var(--brand-main, #e67a88); }
.lang-menu .menu-item.toggle{ cursor:pointer; }
.lang-menu .menu-item.toggle input{ accent-color: var(--brand-main, #e67a88); }
.lang-menu .divider{ height:1px; background:#f1f5f9; margin:6px 4px; border-radius:999px; }

/* ÂèåËØ≠Ê∞îÊ≥°ÂÜÖÊéíÁâà */
.line-1{ font-weight:700; line-height:1.3; }
.line-2{ margin-top:2px; font-size:12px; line-height:1.25; opacity:.9; }
.line-2.muted{ opacity:.7; font-style:italic; }

/* ÂÆ¢ÊúçÂ§¥ÂÉèÔºö‰∏éÂè≥‰∏äËßí SupportButton ‰øùÊåÅ‰∏ÄËá¥ËßÜËßâÔºàÁ≤âÂ∫ï + ËçßÂÖâÁªøÊèèËæπÔºâ */
.cs-support-avatar{ display:inline-grid; place-items:center; border-radius:50%; background: var(--brand-pink, #f17384);
  box-shadow: 0 0 0 2px var(--brand-pink-deep, #ea6f82), 0 0 0 6px var(--brand-ring, #b6ff3f); color:#fff; }
.cs-support-avatar svg{ width: 70%; height: 70%; display:block; }
.cs-support-avatar.cs-sm{ width:28px; height:28px; }
.cs-support-avatar.cs-md{ width:38px; height:38px; }

/* ÊêúÁ¥¢Èù¢ÊùøÊ†∑Âºè */
.tab-bar .tab--search{ flex:0 0 18.75%; }
.tab-bar .tab.active{ flex:1 1 auto; }
/* È°∂ÈÉ®ÂÜÖÂµåÊêúÁ¥¢Ê°ÜÔºàÈ£éÊ†ºËøë‰ººÂØºËà™Ôºâ */
.navlike-search{ position:relative; display:flex; align-items:center; height:34px; }
.navlike-search input{ width:100%; height:34px; border:1px solid #e5e7eb; border-radius:999px; padding:0 40px 0 12px; background:#fff; color:#333; font-weight:600; font-size:13px; }
.navlike-search input::placeholder{ color:#bfbfbf; }
.navlike-search .go{ position:absolute; right:4px; top:50%; transform:translateY(-50%); width:28px; height:28px; border-radius:50%; border:0; background:#fff; color:#999; display:grid; place-items:center; box-shadow:0 1px 2px rgba(0,0,0,.06); }

/* Êñ∞Â∏ÉÂ±ÄÔºö‰æßÊ†è + ËÅäÂ§©Âå∫ÔºàÂ∑¶ÂàóÂÆΩÂ∫¶‰∏∫‰πãÂâçÁöÑ 3/4 ‚âà 18.75%Ôºâ */
.content-grid{ display:grid; grid-template-columns: 18.75% 1fr; gap:0; padding:0; }
.side-col{ min-height:0; overflow:auto; padding:12px; }
.chat-col{ min-height:0; border-left:1px solid #e5e7eb; }

/* ÂàóË°®Ê†∑ÂºèÊ≤øÁî® */
.result-list{ display:flex; flex-direction:column; gap:8px; }
.result-item{ display:flex; align-items:center; gap:10px; border:1px solid #eef2f7; border-radius:12px; padding:8px; background:#fff; transition:background .15s ease, box-shadow .15s ease; }
.result-item:hover{ background:#fafafa; box-shadow:0 2px 10px rgba(0,0,0,.04); }
.ri-main{ flex:1; min-width:0; }
.ri-name{ font-weight:800; color:#111; font-size:13px; line-height:1.25; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.ri-sub{ font-size:10.5px; color:#64748b; font-weight:600; margin-top:1px; word-break:break-all; }
.ri-btn{ height:30px; padding:0 10px; border-radius:999px; background:#f9fafb; border:1px solid #e5e7eb; font-weight:800; white-space:nowrap; }

.recent-head{ font-weight:900; color:#111; margin:6px 2px; font-size:13px; }
.recent-list{ display:flex; flex-direction:column; gap:8px; }
.recent-item{ display:flex; align-items:center; gap:10px; border:1px solid #eef2f7; border-radius:12px; padding:8px; cursor:pointer; background:#fff; transition:background .15s ease, box-shadow .15s ease; }
.recent-item:hover{ background:#fafafa; box-shadow:0 2px 10px rgba(0,0,0,.04); }
.rc-main{ flex:1; min-width:0; }
.rc-top{ display:flex; align-items:center; justify-content:space-between; color:#111; }
.rc-name{ font-weight:800; font-size:13px; line-height:1.25; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.rc-time{ font-size:11px; color:#94a3b8; font-weight:700; margin-left:8px; white-space:nowrap; }
.rc-msg{ color:#6b7280; font-size:11.5px; line-height:1.3; margin-top:2px; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; font-weight:600; }
.rc-unread{ min-width:18px; height:18px; padding:0 4px; border-radius:999px; background:#ef4444; color:#fff; font-size:11px; line-height:18px; text-align:center; font-weight:900; box-shadow:0 0 0 2px #fff; }
.result-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.recent-wrap{ background:#fff; border:1px solid #eef2f7; border-radius:12px; padding:10px; }
.rc-unread{ min-width:18px; height:18px; padding:0 4px; border-radius:999px; background:#ef4444; color:#fff; font-size:11px; line-height:18px; text-align:center; font-weight:900; box-shadow:0 0 0 2px #fff; }
/* Á§ºÁâ©Âç°ÁâáÊ†∑ÂºèÔºàÂºπÁ™óÂÜÖÂ§çÁî®Ôºâ */
.g-card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:10px; box-shadow:0 4px 14px rgba(0,0,0,.06); }
.g-thumb{ display:grid; place-items:center; height:110px; background:linear-gradient(135deg,#fff5f7,#fef3c7); border-radius:12px; overflow:hidden; }
.g-thumb img{ width:74px; height:74px; object-fit:contain; }
.g-meta{ display:flex; align-items:center; justify-content:space-between; font-weight:800; }
.g-name{ color:#111827; font-size:14px; }
.g-price{ color: var(--brand-main, #e67a88); font-size:14px; }
.g-send{ height:34px; border-radius:10px; background: var(--brand-main, #e67a88); color:#fff; font-weight:800; }
.g-send:hover{ filter:brightness(1.06); }

/* ÈÄâ‰∏≠ÊñáÊú¨ÁøªËØëÊÇ¨ÊµÆ UI */
.seltr-wrap{ pointer-events:auto; }
.seltr-box{ background:#fff; border:1px solid #e5e7eb; border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,.12); display:flex; align-items:center; position:relative; }
.seltr-btn{ padding:8px 14px; font-weight:800; background:transparent; border:0; border-radius:999px; cursor:pointer; }
.seltr-btn:hover{ background:#f9fafb; }
.seltr-lang{ position:absolute; top:calc(100% + 6px); left:0; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,.14); padding:6px; display:flex; gap:6px; }
.seltr-lang .lang-item{ padding:6px 10px; border-radius:8px; border:0; background:#fff; font-weight:700; cursor:pointer; }
.seltr-lang .lang-item:hover{ background:#f1f5f9; }
.seltr-result{ margin-top:8px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.14); overflow:hidden; }
.seltr-result .content{ padding:10px 12px; font-weight:700; max-width: 60vw; max-height: 40vh; overflow:auto; }
.seltr-result .actions{ display:flex; justify-content:flex-end; gap:8px; padding:8px; border-top:1px solid #f1f5f9; }
.seltr-result .actions button{ padding:6px 10px; border-radius:8px; border:0; background:#f8fafc; font-weight:800; }
.seltr-result .actions button:hover{ background:#eef2f7; }

/* Á§ºÁâ©Ê∞îÊ≥°Èù¢ÊùøÔºàÈîöÂÆöÊåâÈíÆÔºâ */
.gift-popover{ width: 460px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 14px 34px rgba(0,0,0,.16); z-index:10020; overflow:hidden; }
.gift-popover .gp-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #f1f5f9; }
.gift-popover .gp-title{ font-weight:900; color:#111827; display:flex; align-items:center; gap:6px; }
.gift-popover .gp-title .emoji{ font-size:18px; }
.gift-popover .gp-close{ width:28px; height:28px; border-radius:50%; border:0; background:#f8fafc; }
.gift-popover .gp-close:hover{ background:#eef2f7; }
.gift-popover .gp-body{ max-height: 360px; overflow:auto; padding:10px; }
.gift-popover .gp-loading,.gift-popover .gp-error{ padding:40px 0; text-align:center; color:#64748b; font-weight:700; }
.gift-popover .gp-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
.gift-popover .gp-item{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:8px; border:1px solid #eef2f7; border-radius:12px; background:#fff; cursor:pointer; }
.gift-popover .gp-item:hover{ background:#fafafa; box-shadow:0 2px 10px rgba(0,0,0,.04); }
.gift-popover .gp-item .thumb{ width:100%; height:96px; display:grid; place-items:center; background:linear-gradient(135deg,#fff5f7,#fef3c7); border-radius:10px; overflow:hidden; }
.gift-popover .gp-item .thumb img{ width:56px; height:56px; object-fit:contain; }
.gift-popover .gp-item .name{ font-weight:800; color:#111; font-size:13px; }
.gift-popover .gp-item .price{ color: var(--brand-main, #e67a88); font-weight:900; font-size:13px; }
.gift-popover .gp-foot{ border-top:1px solid #f1f5f9; padding:8px; display:flex; justify-content:flex-end; }
.gift-popover .gp-more{ border:0; background:#f8fafc; padding:8px 12px; border-radius:10px; font-weight:800; }
.gift-popover .gp-more:hover{ background:#eef2f7; }

/* ÂçïÊù°Ê∂àÊÅØÁøªËØëËèúÂçï */
.msgtr-menu{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.14); padding:8px; width:200px; }
.msgtr-menu .msgtr-head{ font-size:12px; color:#64748b; font-weight:800; padding:4px 8px 6px; }
.msgtr-menu .msgtr-list{ display:flex; flex-direction:column; gap:6px; }
.msgtr-menu .msgtr-item{ text-align:left; padding:8px 10px; border-radius:8px; border:0; background:#fff; font-weight:800; }
.msgtr-menu .msgtr-item:hover{ background:#f9fafb; }
</style>

<style>
/* ËÉåÊôØÂÆåÂÖ®Áî±ÂêéÁ´ØËøîÂõûÁöÑ URL ÊéßÂà∂Ôºå‰∏çÂÜç‰ªéÂâçÁ´ØÂÜôÊ≠ª */
/* ÂÖ®Â±ÄÔºöemoji ÈÄâÊã©Âô®Â§ñËßÇÈÄÇÈÖçÔºàÊúÄÂ∞èÂåñÊ†∑ÂºèÔºåÈÅøÂÖçÁõ¥Êé•‰æùËµñÂåÖÂÜÖ CSS Ë∑ØÂæÑÔºâ */
.emoji-picker{ box-shadow: 0 10px 30px rgba(0,0,0,.15); border-radius:12px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); background:#fff; border:1px solid rgba(17,24,39,0.06); }
.emoji-picker .emoji-picker__search-container{ padding:8px; border-bottom:1px solid rgba(17,24,39,0.06); }
.emoji-picker .emoji-picker__search{ width:100%; height:32px; border:1px solid #e5e7eb; border-radius:8px; padding:0 10px; }
.emoji-picker .emoji-picker__category-buttons{ display:flex; gap:6px; padding:6px; border-bottom:1px solid rgba(17,24,39,0.06); }
.emoji-picker .emoji-picker__emojis{ max-height:260px; overflow:auto; padding:6px; display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; }
.emoji-picker .emoji-picker__emoji{ display:grid; place-items:center; width:32px; height:32px; border-radius:6px; cursor:pointer; }
.emoji-picker .emoji-picker__emoji:hover{ background:#f3f4f6; }
</style>
